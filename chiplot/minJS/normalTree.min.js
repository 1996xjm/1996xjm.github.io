import{getNodeHeight,MainTree,maxLength}from"/static/xiaochiPlot/minJS/mainTree.min.js";import{BarPlot}from"/static/xiaochiPlot/js/barPlot.js";import{splitPath}from"/static/xiaochiPlot/js/splitPath.js";class NormalTree extends MainTree{constructor(){super("treefile"),this.barPlot=new BarPlot(this),this.plotType="normalTree",this.creatVueApp()}init(t,a,e){if(console.log("树枝排序",t,a,e),"attrChanged"==t&&"Branches sorting"==e||"originalJsonData"==t)return console.log(this.styleData),void this.reRootTree(this.styleData.rootNodeIndex,this.styleData.rootOffsetRate);"attrChanged"==t&&"data-source"==a&&"Bootstraps"==e&&(l=(l=this.figureData.branches.Bootstraps["data-source"]).optionList[l.value],console.log(99999,l),l in this.btRangeDict?(console.log(this.btRangeDict[l]),this.figureData.branches.Bootstraps.from.value=this.btRangeDict[l][0],this.figureData.branches.Bootstraps.to.value=this.btRangeDict[l][1]):(this.figureData.branches.Bootstraps.from.value=0,this.figureData.branches.Bootstraps.to.value=0),this.Vue.$refs.controlPlane.$forceUpdate());var l=this.figureData.branches["Horizontal layout"].type;this.horizontalLayout=l.optionList[l.value],"attrChanged"==t&&"type"==a&&"Horizontal layout"==e&&(this.figureData.leaves["Text style"]["text-anchor"].value="right to left"==this.horizontalLayout?2:0,this.figureData.leaves["Text style"].x.value=-this.figureData.leaves["Text style"].x.value,this.figureData.branches.Bootstraps.x.value=-this.figureData.branches.Bootstraps.x.value,this.figureData["node ages"]&&(this.figureData["node ages"]["Divergence time"]["text-anchor"].value="right to left"==this.horizontalLayout?0:2,this.figureData["node ages"]["Divergence time"].x.value=-this.figureData["node ages"]["Divergence time"].x.value),this.Vue.$refs.controlPlane.$forceUpdate()),this.zoomG.text("");super.init(),this.root=d3.cluster().size([this.innerHeight,this.innerwidth]).separation((t,a)=>2)(this.treeHierarchy);a=this.figureData.branches.Branches["show-root"].value;null!=this.rootLength&&a?this.root.data.length=this.rootLength:this.root.data.length=0,this.treeScale=parseFloat(this.innerwidth)/parseFloat(maxLength(this.root.data));e=getNodeHeight(this.root);this.setBranchLength(this.root,0,this.treeScale,e+(a?0:-1),e+(a?1:0)),this.maxLength=this.innerwidth,console.log("this.root：",this.root),console.log("maxLength：",maxLength(this.root.data)),this.drawLengthAxis(),this.geologicTimeScale(),this.drawTree(),this.drawNodeAges("normal"),this.drawCollapseClade(),this.drawTextBlock(),this.drawSymbol(),this.drawBarPlot(),this.drawBaseBarPlot(),this.drawBaseLollipopPlot(),this.drawBaseLollipopPlotCategory(),this.drawMotifMEME(),this.drawLinks(),this.drawHeatmap(),this.drawStackedBarPlot(),this.drawBoxPlot(),this.drawBoxPlotCategory(),this.drawPieChart(),this.drawBranchPieChart("normal"),this.drawBinary(),this.drawBinary2(),this.drawBubblePlot(),this.drawTextLabel(),this.drawTextLabelCategory(),this.drawBranchTextLabel("normal"),this.colorBranch(),this.drawRecombinationFragmentMap(),this.drawLegend(),this.setGlobalFontStyle()}drawTree(){const r=this;console.log("link",this.root.links());let a=this.figureData.branches.Branches,t=this.root.links();t.push({source:{branchLength:"right to left"==this.horizontalLayout?this.innerwidth:0,x:this.root.x},target:this.root});this.maingroup.append("g").selectAll("path").data(t).join("path").attr("class",a.id).attr("stroke",a.stroke.value).attr("fill","none").attr("d",t=>{var a=this.figureData.branches.Branches["link-type"];return this.linkHorizontal(t,a.optionList[a.value])}).call(t=>{this.renderAttr(t,a)}).on("click",this.treeBranchClickFunction()).on("touchstart",this.treeBranchClickFunction()).on("mouseenter",this.treeBranchEnterFunction()).on("mouseleave",this.treeBranchleaveFunction());let l=this.maingroup.selectAll("mytext").data(this.root.descendants()).join("g").attr("transform",t=>`translate(${t.branchLength},${t.x})`),e=this.figureData.leaves["Leaves Extension"].extension.value;e&&l.filter(t=>!t.children).append("path").attr("class",this.figureData.leaves["Leaves Extension"].id).attr("d",t=>`M0,0L${("right to left"==this.horizontalLayout?0:this.maxLength)-t.branchLength},0`).call(t=>{this.renderAttr(t,this.figureData.leaves["Leaves Extension"])});var o=this.figureData.branches.Bootstraps.type;let n=o.optionList[o.value];var i=this.figureData.branches.Bootstraps["data-source"];let s=i.optionList[i.value],c=this.Vue.$refs.controlPlane.$data.controlList[0];o=c.findIndex(t=>"BT legend"==t.tabName),i=c.findIndex(t=>"BT color bar legend"==t.tabName);this.figureData.branches.Bootstraps.switch.value&&"None"!=s||(n="None",c[o].isDisplay=!1,c[i].isDisplay=!1);let h=r.figureData.branches.Bootstraps;if("text"==n&&(c[o].isDisplay=!1,c[i].isDisplay=!1,l.filter(t=>t.children).each(function(t,a){let e=d3.select(this);console.log(t);let l=0;"bootstrap"==s&&"btArr"in t.data?l=t.data.btArr[0]:s in r.btRangeDict&&"otherProperty_L"in t.data&&(l=t.data.otherProperty_L[s]),l>=h.from.value&&l<=h.to.value&&(l*=h["scale-by-factor"].value,l=Number(l.toFixed(10)),t=0==h["round-decimals"].value&&l<1?l:d3.format(`.${h["round-decimals"].value}f`)(l),e.selectAll("BTG").data([r.btDragData[a]]).join("g").attr("transform",t=>`translate(${t.x},${t.y})`).call(r.drag()).append("text").attr("class",h.id).text(0!=t?t:"").call(t=>{r.renderAttr(t,h)}))})),"circle"==n&&(c[o].isDisplay=!0,c[i].isDisplay=!1,l.filter(t=>t.children&&"bootstrap"==s&&"btArr"in t.data&&70<=t.data.btArr[0]*h["scale-by-factor"].value).append("g").append("path").attr("d",t=>d3.symbol().type(d3.symbolCircle).size(this.figureData.branches.Bootstraps["circle-size"].value)()).attr("stroke-width",2).attr("fill",t=>90<t.data.btArr[0]*h["scale-by-factor"].value?"black":70<=t.data.btArr[0]*h["scale-by-factor"].value&&t.data.btArr[0]*h["scale-by-factor"].value<=90?"#aaaaaa":void 0).attr("opacity",t=>70<=t.data.btArr[0]*h["scale-by-factor"].value?1:0)),"gradient color circle"==n){c[o].isDisplay=!1,c[i].isDisplay=!0;o=this.figureData["BT color bar legend"]["ColorBar range"];let t=[...this.btRangeDict[s]];i=o["max-value"].value;""!=i&&(t[1]=Number(i));i=o["min-value"].value;""!=i&&(t[0]=Number(i)),this.mmvBTvalue=t;let e=d3.scaleSequential(o.reverse.value?[t[1],t[0]]:t,d3[this.styleData.currentColorInterpolate]);o["median-value"].value&&(i=Number(o["median-value"].value),e=d3.scaleSequential(o.reverse.value?[t[1],i,t[0]]:[t[0],i,t[1]],d3[this.styleData.currentColorInterpolate])),l.filter(t=>{let a=0;return"bootstrap"==s&&"btArr"in t.data&&0<t.data.btArr.length?a=t.data.btArr[0]:s in r.btRangeDict&&"otherProperty_L"in t.data&&(a=t.data.otherProperty_L[s]),t.children&&0!=a}).append("g").append("path").attr("d",t=>d3.symbol().type(d3.symbolCircle).size(this.figureData.branches.Bootstraps["circle-size"].value)()).attr("stroke-width",1).attr("stroke","#000000").attr("fill",t=>{let a=0;return"bootstrap"==s&&"btArr"in t.data?a=t.data.btArr[0]:s in r.btRangeDict&&"otherProperty_L"in t.data&&(a=t.data.otherProperty_L[s]),e(a)})}if("Branches length"in this.figureData.branches&&this.figureData.branches["Branches length"].switch.value){const p=this.figureData.branches["Branches length"];let a="right to left"==this.horizontalLayout?1:-1;l.append("g").attr("transform",t=>`translate(${a*this.treeScale*t.data.length/2},0)`).append("text").text(t=>{return console.log(t),0==p["round-decimals"].value?t.data.length:d3.format(`.${p["round-decimals"].value}f`)(t.data.length)}).attr("class",this.figureData.branches["Branches length"].id).call(t=>{this.renderAttr(t,this.figureData.branches["Branches length"])})}let d=r.figureData.leaves["Text style"]["word-italic"].value,g=[];try{g=d.split(",")}catch(t){}console.log(g);let u=r.layerPlaneData.layerStatistic["word italic"];u=u&&u[0];let m=this.figureData.leaves["Text style"].x.value;l.filter(t=>!t.children).append("g").attr("transform",t=>{var a=t.data.isCollapse&&!this.figureData.branches.Branches["ignore-length"].value?t.data.lengthMMV[1]*this.treeScale:0;return"right to left"==this.horizontalLayout?`translate(${(e?-t.branchLength:a)+m},0)`:`translate(${(e?this.maxLength-t.branchLength:a)+m},0)`}).append("text").attr("dy",".35em").attr("class",this.figureData.leaves["Text style"].id).call(t=>{this.drawLeafText(t)})}drawCollapseClade(){let t=this.root.leaves();var a=t.filter(t=>t.data.isCollapse);let l=this.innerHeight/t.length/2*(1-this.figureData["folded clade"]["Clade style"].padding.value);this.figureData.branches.Branches;this.maingroup.append("g").selectAll("cladePath").data(a).join("path").attr("class",this.figureData["folded clade"]["Clade style"].id).attr("d",t=>{var a=t.data.lengthMMV,e=this.innerwidth/getNodeHeight(this.root);return this.figureData.branches.Branches["ignore-length"].value?`M${t.branchLength-e},${t.x}L${t.branchLength},${t.x-l}L${t.branchLength},${t.x+l}Z`:"right to left"==this.horizontalLayout?`M${t.branchLength},${t.x}L${t.branchLength-a[0]*this.treeScale},${t.x-l}L${t.branchLength-a[1]*this.treeScale},${t.x+l}Z`:`M${t.branchLength},${t.x}L${t.branchLength+a[0]*this.treeScale},${t.x-l}L${t.branchLength+a[1]*this.treeScale},${t.x+l}Z`}).attr("fill",t=>(this.figureData["folded clade"]["Custom color"].switch.value?this.figureData["folded clade"]["Custom color"][t.data.name]:this.figureData["folded clade"]["Clade style"].fill).value).attr("stroke",t=>(this.figureData["folded clade"]["Clade style"]["stroke-as-fill"].value?this.figureData["folded clade"]["Custom color"].switch.value?this.figureData["folded clade"]["Custom color"][t.data.name]:this.figureData["folded clade"]["Clade style"].fill:this.figureData["folded clade"]["Clade style"].stroke).value).call(t=>{this.renderAttr(t,this.figureData["folded clade"]["Clade style"])}).on("mouseenter",this.treeBranchEnterFunction("foldedClade")).on("mouseleave",this.treeBranchleaveFunction("foldedClade")).on("click",this.treeBranchClickFunction("foldedClade")).on("touchstart",this.treeBranchClickFunction("foldedClade"))}drawBarPlot(){let t=this.layerPlaneData.layerStatistic["bar plot with category"]||[];t.forEach((c,t)=>{if(c.isShowObj.isShow){var h=this.layerDataDict[c.layerDataFlieKey].dataSource;let e=this.layerDataDict[c.layerDataFlieKey].dataIndex,l=h.columns[c.layerDataColumnsIndex[1]],a=h.columns[c.layerDataColumnsIndex[0]];var d=c.controlData.canvas["Canvas scale"].width.value;let r=this.innerHeight/this.root.leaves().length*(1-c.controlData.bar["Bar style"].padding.value),o=[],t=this.root.leaves().filter(t=>{var a=e.has(t.data.name)&&e.get(t.data.name)[l];return a&&o.push(e.get(t.data.name)[l]),a});var[g,h]=d3.extent(o),g=d3.scaleLinear().domain(g<0?[g,h]:[0,h]).range([0,d]);c.otherData.dragData||(c.otherData.dragData={x:0,y:0});h=this.maingroup.append("g").attr("transform",t=>`translate(${this.maxLength+parseInt(c.controlData.canvas["Canvas scale"].x.value)},0)`).append("g").data([c.otherData.dragData]).attr("transform",t=>`translate(${t.x},${t.y})`).call(this.drag({enableY:!1}));this.addAxis(c.controlData,h,g);let n=d3.scaleOrdinal().domain(c.categoryList).range(c.categoryColorList);c.controlData.bar["Custom color"].switch.value&&(d=c.categoryList.map(t=>c.controlData.bar["Custom color"][t].value),console.log(d),n.range(d)),c.colorScale=n;let i={},s=t.map(t=>(i[t.data.name]=t.x-r/2,{innerScaleKey:t.data.name,value:e.get(t.data.name)[l],colorScaleKey:e.get(t.data.name)[a]}));s.barStyle=c.controlData.bar["Bar style"],s.textStyle=c.controlData.bar["Bar text"],s.initType=null,s.innerScale=t=>i[t],s.innerScale.bandwidth=()=>r,s.colorScale=n,s.valueScale=g,this.barPlot.drawHorizontalBar1(h,s)}})}drawBaseBarPlot(){let t=this.layerPlaneData.layerStatistic["base bar plot"]||[];t.forEach((i,t)=>{if(i.isShowObj.isShow){var s=this.layerDataDict[i.layerDataFlieKey].dataSource;let e=this.layerDataDict[i.layerDataFlieKey].dataIndex,l=s.columns[i.layerDataColumnsIndex[0]];var c=i.controlData.canvas["Canvas scale"].width.value;let a=this.innerHeight/this.root.leaves().length*(1-i.controlData.bar["Bar style"].padding.value),r=[],t=this.root.leaves().filter(t=>{var a=e.has(t.data.name)&&e.get(t.data.name)[l];return a&&r.push(e.get(t.data.name)[l]),a});var[h,s]=d3.extent(r),s=d3.scaleLinear().domain(h<0?[h,s]:[0,s]).range([0,c]);i.otherData.dragData||(i.otherData.dragData={x:0,y:0});c=this.maingroup.append("g").attr("transform",t=>`translate(${this.maxLength+parseInt(i.controlData.canvas["Canvas scale"].x.value)},0)`).append("g").data([i.otherData.dragData]).attr("transform",t=>`translate(${t.x},${t.y})`).call(this.drag({enableY:!1}));this.addAxis(i.controlData,c,s);d3.scaleOrdinal().domain(i.categoryList).range(i.categoryColorList);let o={},n=t.map(t=>(o[t.data.name]=t.x-a/2,{innerScaleKey:t.data.name,value:e.get(t.data.name)[l],colorScaleKey:t.data.name}));n.barStyle=i.controlData.bar["Bar style"],n.textStyle=i.controlData.bar["Bar text"],n.initType=null,n.innerScale=t=>o[t],n.innerScale.bandwidth=()=>a,n.colorScale=()=>i.controlData.bar["Bar style"].fill.value,n.valueScale=s,this.barPlot.drawHorizontalBar1(c,n)}})}drawBaseLollipopPlot(){let t=this.layerPlaneData.layerStatistic["base lollipop plot"]||[];t.forEach((c,t)=>{if(c.isShowObj.isShow){var h=this.layerDataDict[c.layerDataFlieKey].dataSource;let e=this.layerDataDict[c.layerDataFlieKey].dataIndex,l=h.columns[c.layerDataColumnsIndex[0]];var d=c.controlData.canvas["Canvas scale"].width.value;let a=this.innerHeight/this.root.leaves().length,r=[],t=this.root.leaves().filter(t=>{var a=e.has(t.data.name)&&e.get(t.data.name)[l];return a&&r.push(e.get(t.data.name)[l]),a}),[o,n]=d3.extent(r);var g=d3.scaleLinear().domain(o<0?[o,n]:[0,n]).range([0,d]);c.otherData.dragData||(c.otherData.dragData={x:0,y:0});h=this.maingroup.append("g").attr("transform",t=>`translate(${this.maxLength+parseInt(c.controlData.canvas["Canvas scale"].x.value)},0)`).append("g").data([c.otherData.dragData]).attr("transform",t=>`translate(${t.x},${t.y})`).call(this.drag({enableY:!1}));this.addAxis(c.controlData,h,g);d3.scaleOrdinal().domain(c.categoryList).range(c.categoryColorList);let i={},s=t.map(t=>(i[t.data.name]=t.x-a/2,{innerScaleKey:t.data.name,value:e.get(t.data.name)[l],colorScaleKey:t.data.name}));d=d3.scaleLinear().domain([o,n].map(t=>t<0?0:t)).range([c.controlData.lollipop["Lollipop size"]["min-radius"].value,c.controlData.lollipop["Lollipop size"]["max-radius"].value]);s.barStyle=c.controlData.lollipop["Lollipop style"],s.textStyle=c.controlData.lollipop["Lollipop text"],s.lineStyle=c.controlData.lollipop["Line style"],c.controlData.lollipop["Lollipop size"].switch.value?(s.rScale=d,c.controlData.lollipop["Lollipop style"].r.isSvgAttr=!1):c.controlData.lollipop["Lollipop style"].r.isSvgAttr=!0,s.initType=null,s.innerScale=t=>i[t],s.innerScale.bandwidth=()=>a,s.colorScale=()=>c.controlData.lollipop["Lollipop style"].fill.value,s.valueScale=g,this.barPlot.drawHorizontalLollipop(h,s)}})}drawMotifMEME(){const m=this;let t=m.layerPlaneData.layerStatistic["motif MEME"]||[];t.forEach((d,t)=>{if(d.isShowObj.isShow){let t=this.layerDataDict[d.layerDataFlieKey].dataSource,e=this.layerDataDict[d.layerDataFlieKey].dataIndex;var r=d.controlData.canvas["Canvas scale"].width.value;let n=this.innerHeight/this.root.leaves().length*(1-d.controlData.motif["Motif style"].padding.value),l=[],a=this.root.leaves().filter(t=>{var a=e.has(t.data.name);return a&&l.push(e.get(t.data.name).length),a});var[o,g]=d3.extent(l);let i=d3.scaleLinear().domain(o<0?[o,g]:[0,g]).range([0,r]);d.otherData.dragData||(d.otherData.dragData={x:0,y:0});let s=this.maingroup.append("g").attr("transform",t=>`translate(${this.maxLength+parseInt(d.controlData.canvas["Canvas scale"].x.value)},0)`).append("g").data([d.otherData.dragData]).attr("transform",t=>`translate(${t.x},${t.y})`).call(this.drag({enableY:!1}));this.addAxis(d.controlData,s,i);let c=d3.scaleOrdinal().domain(d.categoryList).range(d.categoryColorList);d.controlData.motif["Custom color"].switch.value&&(u=d.categoryList.map(t=>d.controlData.motif["Custom color"][t].value),console.log(u),c.range(u)),d.colorScale=c;var u=d.controlData.motif["Motif style"].type;let h="Motif Sites"==u.optionList[u.value]?"contributing_sites":"contributing_sites_and_scanned_sites";a.forEach(a=>{let r=a.x-n/2,o=s.append("g");o.append("line").attr("class",d.controlData.motif["Line style"].id).attr("x2",t=>i(e.get(a.data.name).length)).attr("y1",a.x).attr("y2",a.x).call(t=>{this.renderAttr(t,d.controlData.motif["Line style"])}),t.columns.slice(2).forEach(l=>{var t=e.get(a.data.name)[l];if(null!=t){let e=JSON.parse(t);console.log(e),o.selectAll("motif_item").data(e[h]).join("g").call(t=>{t.append("rect").attr("class",d.controlData.motif["Motif style"].id).attr("x",t=>i(t.start)).attr("y",r).attr("width",t=>i(t.end)-i(t.start)).attr("height",n).attr("fill",c(l)).call(t=>{this.renderAttr(t,d.controlData.motif["Motif style"])}).on("mouseenter",function(t){var[a]=d3.select(this).data();m.layerPlaneData.layerInformationHoverBoxClientX=t.clientX+20,m.layerPlaneData.layerInformationHoverBoxClientY=t.clientY,m.layerPlaneData.layerInformationHoverBoxTitle="Motif information",m.layerPlaneData.layerInformationHoverBoxDataArr=[{key:"ID",value:l},{key:"Motif",value:e.motif_meta.name},{key:"p-value",value:a.pvalue},{key:"Start",value:a.start},{key:"End",value:a.end}],m.layerPlaneData.isShowLayerInformationHoverBox=!0}).on("mouseleave",t=>{m.layerPlaneData.isShowLayerInformationHoverBox=!1}),d.controlData.motif["Motif text"].switch.value&&t.append("text").text(l.split("_")[1]).attr("class",d.controlData.motif["Motif text"].id).attr("x",t=>(i(t.end)+i(t.start))/2).attr("y",a.x).attr("dy","0.35em").attr("text-anchor","middle").call(t=>{this.renderAttr(t,d.controlData.motif["Motif text"])})})}})})}})}drawBaseLollipopPlotCategory(){let t=this.layerPlaneData.layerStatistic["lollipop plot with category"]||[];t.forEach((d,t)=>{if(d.isShowObj.isShow){var g=this.layerDataDict[d.layerDataFlieKey].dataSource;let e=this.layerDataDict[d.layerDataFlieKey].dataIndex,l=g.columns[d.layerDataColumnsIndex[1]],a=g.columns[d.layerDataColumnsIndex[0]];var u=d.controlData.canvas["Canvas scale"].width.value;let r=this.innerHeight/this.root.leaves().length,o=[],t=this.root.leaves().filter(t=>{var a=e.has(t.data.name)&&e.get(t.data.name)[l];return a&&o.push(e.get(t.data.name)[l]),a}),[n,i]=d3.extent(o);g=d3.scaleLinear().domain(n<0?[n,i]:[0,i]).range([0,u]);d.otherData.dragData||(d.otherData.dragData={x:0,y:0});u=this.maingroup.append("g").attr("transform",t=>`translate(${this.maxLength+parseInt(d.controlData.canvas["Canvas scale"].x.value)},0)`).append("g").data([d.otherData.dragData]).attr("transform",t=>`translate(${t.x},${t.y})`).call(this.drag({enableY:!1}));this.addAxis(d.controlData,u,g);let s=d3.scaleOrdinal().domain(d.categoryList).range(d.categoryColorList);d.controlData.lollipop["Lollipop color"].switch.value&&(m=d.categoryList.map(t=>d.controlData.lollipop["Lollipop color"][t].value),console.log(m),s.range(m)),d.colorScale=s;let c={},h=t.map(t=>(c[t.data.name]=t.x-r/2,{innerScaleKey:t.data.name,value:e.get(t.data.name)[l],colorScaleKey:e.get(t.data.name)[a]}));var m=d3.scaleLinear().domain([n,i].map(t=>t<0?0:t)).range([d.controlData.lollipop["Lollipop size"]["min-radius"].value,d.controlData.lollipop["Lollipop size"]["max-radius"].value]);h.barStyle=d.controlData.lollipop["Lollipop style"],h.textStyle=d.controlData.lollipop["Lollipop text"],h.lineStyle=d.controlData.lollipop["Line style"],d.controlData.lollipop["Lollipop size"].switch.value?(h.rScale=m,d.controlData.lollipop["Lollipop style"].r.isSvgAttr=!1):d.controlData.lollipop["Lollipop style"].r.isSvgAttr=!0,h.initType=null,h.innerScale=t=>c[t],h.innerScale.bandwidth=()=>r,h.colorScale=s,h.valueScale=g,this.barPlot.drawHorizontalLollipop(u,h)}})}drawLinks(){let t=this.layerPlaneData.layerStatistic["link between two nodes"]||[];this.figureData.leaves["Leaves Extension"].extension.value;let c={};this.root.leaves().forEach(t=>{c[t.data.name]={x:this.maxLength,y:t.x}});let h=d3.line().curve(d3.curveBundle).y(t=>t.y).x(t=>t.x);console.log(c),t.forEach((s,t)=>{if(s.isShowObj.isShow){let r=this.layerDataDict[s.layerDataFlieKey].dataSource;console.log("9jjj",r),console.log(this.root.leaves());let i=s.controlData.link["Link color"]["color-type"];var a,o=r.map(t=>{var a=s.controlData.link["Link style"]["link-type"],e=Math.abs(c[t.source].y-c[t.target].y)/2,l=s.controlData.link["Link style"]["offset-x"].value,r={x:c[t.source].x+l,y:c[t.source].y},o=(this.maxLength,Math.sin(Math.PI/4),c[t.source].y,c[t.target].y,Math.sin(Math.PI/4),c[t.source].y,c[t.target].y,{x:this.maxLength+e+l,y:(c[t.source].y+c[t.target].y)/2}),t=(this.maxLength,Math.sin(Math.PI/4),c[t.source].y,c[t.target].y,Math.sin(Math.PI/4),c[t.source].y,c[t.target].y,{x:c[t.target].x+l,y:c[t.target].y});if("pure"==i.optionList[i.value]||s.controlData.link["Color categories"]&&s.controlData.link["Color categories"].switch.value)return"elliptical"==a.optionList[a.value]?h([r,o,t]):h([r,t]);let n="elliptical"==a.optionList[a.value]?splitPath(h,[r,o,t]):splitPath(h,[r,t]);return Array.from(n.split(8))});if(console.log("pathData",o),"pure"==i.optionList[i.value]||s.controlData.link["Color categories"]&&s.controlData.link["Color categories"].switch.value){let l=d3.scaleOrdinal().domain(s.categoryList);return s.controlData.link["Color categories"]&&s.controlData.link["Color categories"].switch.value&&(a=s.categoryList.map(t=>s.controlData.link["Color categories"][t].value),console.log(a),l.range(a)),s.colorScale=l,void this.maingroup.append("g").selectAll("nodelink").data(o).join("path").attr("d",t=>t).attr("fill","none").attr("stroke",(t,a)=>{if(s.controlData.link["Color categories"]&&s.controlData.link["Color categories"].switch.value){var e=r.columns[s.layerDataColumnsIndex[2]];return l(r[a][e])}return s.controlData.link["Link color"].pure.value}).call(t=>{this.renderAttr(t,s.controlData.link["Link style"])})}o=d3.transpose(o);d3.interpolateRgbBasis(["#ffffff","#ff6668"]);let e=d3.interpolateRgbBasis([s.controlData.link["Link color"].source.value,s.controlData.link["Link color"].target.value]);this.maingroup.append("g").selectAll("nodelink").data(o).join("path").attr("d",t=>t.join("")).attr("fill","none").attr("stroke",(t,a)=>e(d3.easeQuad(a/255))).call(t=>{this.renderAttr(t,s.controlData.link["Link style"])})}})}drawHeatmap(){const m=this;let t=m.layerPlaneData.layerStatistic.heatmap||[];console.log("heatmap"),console.log(t);let p=this.innerHeight/this.root.leaves().length;t.forEach((c,t)=>{if(c.isShowObj.isShow){var h=this.layerDataDict[c.layerDataFlieKey].dataSource;let l=this.layerDataDict[c.layerDataFlieKey].dataIndex,r=h.columns;this.root.leaves().filter(t=>l.has(t.data.name));let t=this.root.leaves().map(e=>{if(l.has(e.data.name)){let a={};return c.layerDataColumnsIndex.forEach(t=>{a[r[t]]=l.get(e.data.name)[r[t]]}),a}return null});t.columns=c.layerDataColumnsIndex.map(t=>r[t]),c.controlData.cell["Columns sorting"]&&c.controlData.cell["Columns sorting"]["sort-by-leaves"].value&&(t.columns=this.root.leaves().map(t=>t.data.name)),console.log(t);var d=c.controlData.cell["Cell style"]["zero-style"];let n=d.optionList[d.value];var g=c.controlData.canvas["Canvas scale"].width.value;let a=d3.scaleBand().domain(t.columns).range([0,g]),i=a.bandwidth();c.otherData.dragData||(c.otherData.dragData={x:0,y:0});let e=this.maingroup.append("g").attr("transform",t=>`translate(${this.maxLength+parseInt(c.controlData.canvas["Canvas scale"].x.value)},0)`).append("g").data([c.otherData.dragData]).attr("transform",t=>`translate(${t.x},${t.y})`).call(this.drag({enableY:!1})),o=m.getMaxMinValue(t.filter(t=>null!=t),t.columns);var u=c.controlData.legend["ColorBar range"]["max-value"].value;""!=u&&Number(u)>o[1]&&(o[1]=Number(u));h=c.controlData.legend["ColorBar range"]["min-value"].value;""!=h&&Number(h)<o[0]&&(o[0]=Number(h)),c.mmv=o,c.customColorInterpolate=d3[c.colorInterpolate||"interpolateRdBu"],c.controlData.cell["Color bar"]["custom-color"].value&&(d=c.controlData.cell["Color bar"]["gradient-type"],g=c.controlData.cell["Color bar"].start.value,u=c.controlData.cell["Color bar"].middle.value,h=c.controlData.cell["Color bar"].end.value,"start-end"==d.optionList[d.value]?c.customColorInterpolate=d3.scaleLinear().domain([0,1]).range([g,h]):c.customColorInterpolate=d3.scaleLinear().domain([0,.5,1]).range([g,u,h]));let s=d3.scaleSequential(c.controlData.legend["ColorBar range"].reverse.value?[c.mmv[1],c.mmv[0]]:c.mmv,c.customColorInterpolate);if(c.controlData.legend["ColorBar range"]["median-value"].value){let e=Number(c.controlData.legend["ColorBar range"]["median-value"].value);s=t=>{let a=d3.scaleLinear().domain(c.controlData.legend["ColorBar range"].reverse.value?[o[1],e,o[0]]:[o[0],e,o[1]]).range([0,.5,1]);return c.customColorInterpolate(a(t))}}this.addAxis(c.controlData,e,a),e.selectAll(".row").data(t).join("g").attr("transform",(t,a)=>`translate(0,${a*p})`).filter(t=>null!=t).each(function(l,r){let o=d3.select(this);t.columns.forEach((e,t)=>{var a=c.controlData.cell["Cell style"]["layout-type"];if(a){if("up"==a.optionList[a.value]&&t<r)return;if("down"==a.optionList[a.value]&&r<t)return}a=c.controlData.cell["Cell style"]["no-fill-diagonal"];a&&a.value&&r==t||null!=l[e]&&(o.append("rect").attr("x",t*i).attr("width",i+.5).attr("height",.5+p).attr("fill",t=>0==t[e]&&"normal"!=n?"none":s(t[e])).call(t=>{m.renderAttr(t,c.controlData.cell["Cell style"])}).attr("stroke-width",t=>0==t[e]&&"blank"==n?0:c.controlData.cell["Cell style"]["stroke-width"].value).append("title").text(t=>t[e]),c.controlData.cell["Cell text"].switch.value&&o.filter(t=>!!c.controlData.cell["Cell text"]["zero-text"].value||0!=t[e]).append("text").text(t=>{let a=d3.format(`.${c.controlData.cell["Cell text"]["round-decimals"].value}f`);return a(t[e])}).attr("x",(t+.5)*i).attr("y",.5*p).attr("dy","0.35em").attr("text-anchor","middle").call(t=>{m.renderAttr(t,c.controlData.cell["Cell text"])}).attr("fill",t=>{return.5<d3.hsl(s(t[e])).l?"#222":"#fff"}))})})}})}drawStackedBarPlot(){let t=this.layerPlaneData.layerStatistic["stacked bar plot"]||[];console.log(t);this.innerHeight,this.root.leaves().length;t.forEach((s,t)=>{if(s.isShowObj.isShow){var c=this.layerDataDict[s.layerDataFlieKey].dataSource;let r=this.layerDataDict[s.layerDataFlieKey].dataIndex,o=c.columns,t=[];this.root.leaves().forEach(l=>{if(r.has(l.data.name)){let a={x:l.x},e=0;s.layerDataColumnsIndex.forEach(t=>{null==r.get(l.data.name)[o[t]]&&e++,a[o[t]]=r.get(l.data.name)[o[t]]||0}),e!=s.layerDataColumnsIndex.length&&t.push(a)}}),t.columns=s.layerDataColumnsIndex.map(t=>o[t]);let a=d3.stack().keys(t.columns).offset(d3.stackOffsetNone)(t);console.log(t),console.log(a);c=s.controlData.canvas["Canvas scale"].width.value;let e=d3.scaleLinear().domain([0,d3.max(a,t=>d3.max(t,t=>t[1]))]).range([0,c]),l=d3.scaleOrdinal().domain(a.map(t=>t.key)).range(0==s.categoryColorList.length?["#8dd3c7","#ffffb3","#bebada","#fb8072","#80b1d3","#fdb462","#b3de69","#fccde5","#d9d9d9","#bc80bd","#ccebc5","#ffed6f"]:s.categoryColorList);s.isUseColorGradient&&l.range(d3.quantize(d3[s.colorInterpolate],l.domain().length)),s.controlData.bar["Custom color"].switch.value&&(c=a.map(t=>s.controlData.bar["Custom color"][t.key].value),l.range(c)),s.colorScale=l,console.log("9kk",s.categoryColorList);let n=this.innerHeight/this.root.leaves().length*(1-s.controlData.bar["Bar style"].padding.value);s.otherData.dragData||(s.otherData.dragData={x:0,y:0});let i=this.maingroup.append("g").attr("transform",t=>`translate(${this.maxLength+Number(s.controlData.canvas["Canvas scale"].x.value)},0)`).append("g").data([s.otherData.dragData]).attr("transform",t=>`translate(${t.x},${t.y})`).call(this.drag({enableY:!1}));this.addAxis(s.controlData,i,e),i.selectAll(".barG").data(a).join("g").attr("class",s.controlData.bar["Bar style"].id).attr("fill",t=>l(t.key)).call(t=>{this.renderAttr(t,s.controlData.bar["Bar style"]),t.append("title").text(t=>t.key),t.selectAll("rect").data(t=>t).join("rect").attr("y",t=>t.data.x-n/2).attr("width",t=>e(t[1])-e(t[0])).attr("height",n).attr("x",t=>e(t[0]))})}})}drawBoxPlot(){const h=this;let t=h.layerPlaneData.layerStatistic["base box plot"]||[];console.log(t),t.forEach((n,t)=>{if(n.isShowObj.isShow){var l=this.layerDataDict[n.layerDataFlieKey].dataSource;let r=this.layerDataDict[n.layerDataFlieKey].dataIndex,o=l.columns,i=[];this.root.leaves().forEach(l=>{if(r.has(l.data.name)){let a={leafName:l.data.name},e=0;n.layerDataColumnsIndex.forEach(t=>{null==r.get(l.data.name)[o[t]]&&e++,a[o[t]]=r.get(l.data.name)[o[t]]}),e!=n.layerDataColumnsIndex.length&&i.push(a)}}),i.columns=n.layerDataColumnsIndex.map(t=>o[t]),console.log(i);var s=h.getMaxMinValue(i,i.columns),c=n.controlData.canvas["Canvas scale"].width.value,l=d3.scaleLinear().domain(s).range([0,c]),s=d3.scaleOrdinal().range([n.controlData.box["Box style"].fill.value]);let t=i.map(a=>{let e=i.columns.map(t=>a[t]).filter(t=>null!=t);var[t,l,r,o,n]=[0,.25,.5,.75,1].map(t=>d3.quantile(e,t));return{name:a.leafName,min:t,q1:l,m:r,q3:o,max:n,sd:null,dataArr:e}}),a=this.innerHeight/this.root.leaves().length*(1-n.controlData.box["Box style"].padding.value),e={};this.root.leaves().forEach(t=>{e[t.data.name]=t.x-a/2});c=function(t){return e[t]};c.bandwidth=()=>a,t.innerxScale=c,t.xScale=l,t.colorScale=s,t.boxStyle=n.controlData.box["Box style"],t.pointStyle=n.controlData.point["Point style"],t.significanceStyle=n.controlData.significance,console.log("9kk",n.categoryColorList),n.otherData.dragData||(n.otherData.dragData={x:0,y:0});s=this.maingroup.append("g").attr("transform",t=>`translate(${this.maxLength+Number(n.controlData.canvas["Canvas scale"].x.value)},0)`).append("g").data([n.otherData.dragData]).attr("transform",t=>`translate(${t.x},${t.y})`).call(this.drag({enableY:!1}));this.addAxis(n.controlData,s,l),h.barPlot.drawHorizontalBox(s,t)}})}drawBoxPlotCategory(){const g=this;let t=g.layerPlaneData.layerStatistic["box plot with category"]||[];console.log(t),t.forEach((o,t)=>{if(o.isShowObj.isShow){var n=this.layerDataDict[o.layerDataFlieKey].dataSource;let i=this.layerDataDict[o.layerDataFlieKey].dataIndex,r=n.columns,s=n.columns[o.layerDataColumnsIndex[0]],c=[],t=o.layerDataColumnsIndex.slice(1);this.root.leaves().forEach(l=>{if(i.has(l.data.name)){let a={leafName:l.data.name},e=0;t.forEach(t=>{null==i.get(l.data.name)[r[t]]&&e++,a[r[t]]=i.get(l.data.name)[r[t]]}),e!=t.length&&c.push(a)}}),c.columns=t.map(t=>r[t]),console.log(c);var h=g.getMaxMinValue(c,c.columns),d=o.controlData.canvas["Canvas scale"].width.value,n=d3.scaleLinear().domain(h).range([0,d]),h=d3.scaleOrdinal().domain(o.categoryList).range(o.categoryColorList);o.colorScale=h;let a=c.map(a=>{let e=c.columns.map(t=>a[t]).filter(t=>null!=t);var[t,l,r,o,n]=[0,.25,.5,.75,1].map(t=>d3.quantile(e,t));return{name:a.leafName,colorScaleKey:i.get(a.leafName)[s],min:t,q1:l,m:r,q3:o,max:n,sd:null,dataArr:e}}),e=this.innerHeight/this.root.leaves().length*(1-o.controlData.box["Box style"].padding.value),l={};this.root.leaves().forEach(t=>{l[t.data.name]=t.x-e/2});d=function(t){return l[t]};d.bandwidth=()=>e,a.innerxScale=d,a.xScale=n,a.colorScale=h,a.boxStyle=o.controlData.box["Box style"],a.pointStyle=o.controlData.point["Point style"],a.significanceStyle=o.controlData.significance,console.log("9kk",o.categoryColorList),o.otherData.dragData||(o.otherData.dragData={x:0,y:0});h=this.maingroup.append("g").attr("transform",t=>`translate(${this.maxLength+Number(o.controlData.canvas["Canvas scale"].x.value)},0)`).append("g").data([o.otherData.dragData]).attr("transform",t=>`translate(${t.x},${t.y})`).call(this.drag({enableY:!1}));this.addAxis(o.controlData,h,n),g.barPlot.drawHorizontalBox(h,a)}})}drawBinary2(){let t=this.layerPlaneData.layerStatistic["binary type 2"]||[];console.log("heatmap"),console.log(t);let s=this.innerHeight/this.root.leaves().length;t.forEach((n,t)=>{if(n.isShowObj.isShow){var i=this.layerDataDict[n.layerDataFlieKey].dataSource;let l=this.layerDataDict[n.layerDataFlieKey].dataIndex,r=i.columns,a=this.root.leaves().map(e=>{if(l.has(e.data.name)){let a={};return n.layerDataColumnsIndex.forEach(t=>{a[r[t]]=l.get(e.data.name)[r[t]]}),a}return null});a.columns=n.layerDataColumnsIndex.map(t=>r[t]),console.log(a);i=n.controlData.canvas["Canvas scale"].width.value;let t=d3.scaleBand().domain(a.columns).range([0,i]),o=t.bandwidth();n.otherData.dragData||(n.otherData.dragData={x:0,y:0});let e=this.maingroup.append("g").attr("transform",t=>`translate(${this.maxLength+parseInt(n.controlData.canvas["Canvas scale"].x.value)},0)`).append("g").data([n.otherData.dragData]).attr("transform",t=>`translate(${t.x},${t.y})`).call(this.drag({enableY:!1}));this.addAxis(n.controlData,e,t),e.selectAll(".row").data(a).join("g").attr("transform",(t,a)=>`translate(0,${a*s})`).filter(t=>null!=t).call((e,t)=>{a.columns.forEach((a,t)=>{e.filter(t=>null!=t[a]).append("rect").attr("x",t*o).attr("width",o).attr("height",s).attr("class",n.controlData.cell["Cell style"].id).attr("fill-opacity",t=>n.controlData.cell["Custom color"].switch.value?(n.controlData.cell["Cell style"].fill.isSvgAttr=!1,1):0==t[a]?.4:1).attr("fill",t=>(n.controlData.cell["Custom color"].switch.value?0==t[a]?n.controlData.cell["Custom color"].absent:n.controlData.cell["Custom color"].present:n.controlData.cell["Cell style"].fill).value).call(t=>{this.renderAttr(t,n.controlData.cell["Cell style"])}).append("title").text(t=>t[a]),n.controlData.cell["Cell text"].switch.value&&e.append("text").text(t=>t[a]).attr("x",(t+.5)*o).attr("y",.5*s).attr("dy","0.35em").attr("class",n.controlData.cell["Cell text"].id).attr("text-anchor","middle").call(t=>{this.renderAttr(t,n.controlData.cell["Cell text"])}).attr("fill",t=>{return.5<d3.hsl(n.controlData.cell["Cell style"].fill.value).l?"#222":"#fff"})})})}})}drawBinary(){let t=this.layerPlaneData.layerStatistic["binary type 1"]||[];console.log(t);let h=this.innerHeight/this.root.leaves().length;t.forEach((i,t)=>{if(i.isShowObj.isShow){let l=this.layerDataDict[i.layerDataFlieKey].dataIndex,e=this.root.leaves().map(e=>{if(l.has(e.data.name)){let a={};return i.categoryList.forEach(t=>{a[t]=l.get(e.data.name)[t]}),a}return null});e.columns=i.categoryList,console.log(e);var s=i.controlData.canvas["Canvas scale"].width.value;let t=d3.scaleBand().domain(e.columns).range([0,s]),r=t.bandwidth();i.otherData.dragData||(i.otherData.dragData={x:0,y:0});let a=this.maingroup.append("g").attr("transform",t=>`translate(${this.maxLength+parseInt(i.controlData.canvas["Canvas scale"].x.value)},0)`).append("g").data([i.otherData.dragData]).attr("transform",t=>`translate(${t.x},${t.y})`).call(this.drag({enableY:!1})),o=d3.scaleOrdinal().domain(e.columns).range(0==i.categoryColorList.length?["#cccccc"]:i.categoryColorList);i.controlData.cell["Pure color"].switch.value&&o.range([i.controlData.cell["Pure color"].color.value]),i.controlData.cell["Custom color"].switch.value&&o.range(i.categoryList.map(t=>i.controlData.cell["Custom color"][t].value)),this.addAxis(i.controlData,a,t);var c=Math.min(r,h)/2*i.controlData.cell["Cell style"]["size-rate"].value,s=i.controlData.cell["Cell style"]["symbol-type"],s=s.optionList[s.value];let n=this.symbolGenerator.getPath(s,c);a.selectAll(".row").data(e).join("g").attr("transform",(t,a)=>`translate(0,${a*h})`).filter(t=>null!=t).call((t,a)=>{e.columns.forEach((a,e)=>{t.filter(t=>null!=t[a]).append("g").attr("transform",(t,a)=>`translate(${(e+.5)*r},${h/2})`).append("path").attr("d",n).attr("fill",t=>0==t[a]?"none":o(a)).attr("stroke",t=>o(a)).attr("class",i.controlData.cell["Cell style"].id).call(t=>{this.renderAttr(t,i.controlData.cell["Cell style"])}).append("title").text(t=>t[a])})})}})}drawBubblePlot(){const g=this;let t=g.layerPlaneData.layerStatistic["bubble plot"]||[];console.log(t);let u=this.innerHeight/this.root.leaves().length;t.forEach((s,t)=>{if(s.isShowObj.isShow){let l=this.layerDataDict[s.layerDataFlieKey].dataIndex,e=this.root.leaves().map(e=>{if(l.has(e.data.name)){let a={};return s.categoryList.forEach(t=>{a[t]=l.get(e.data.name)[t]}),a}return null});e.columns=s.categoryList,console.log(e);var c=g.getMaxMinValue(e.filter(t=>null!=t),e.columns);s.mmv=c;var h=s.controlData.canvas["Canvas scale"].width.value;let t=d3.scaleBand().domain(e.columns).range([0,h]),r=t.bandwidth();s.otherData.dragData||(s.otherData.dragData={x:0,y:0});let a=this.maingroup.append("g").attr("transform",t=>`translate(${this.maxLength+parseInt(s.controlData.canvas["Canvas scale"].x.value)},0)`).append("g").data([s.otherData.dragData]).attr("transform",t=>`translate(${t.x},${t.y})`).call(this.drag({enableY:!1})),o=d3.scaleOrdinal().domain(e.columns).range(0==s.categoryColorList.length?["#cccccc"]:s.categoryColorList);console.log(s.controlData),s.controlData.bubble["Custom color"].switch.value&&o.range(s.categoryList.map(t=>s.controlData.bubble["Custom color"][t].value)),s.controlData.bubble["Pure color"].switch.value&&o.range([s.controlData.bubble["Pure color"].fill.value]),this.addAxis(s.controlData,a,t);var d=Math.min(r,u)/2,h=s.controlData.bubble["Bubble size"]["max-radius"].value;let n=d3.scaleLinear().domain([0,c[0],c[1]]).range([0,s.controlData.bubble["Bubble size"]["min-radius"].value,d<h?h:d]);s.rScale=n;d=s.controlData.bubble["Bubble style"]["symbol-type"];let i=d.optionList[d.value];s.symbolType=i,a.selectAll(".row").data(e).join("g").attr("transform",(t,a)=>`translate(0,${a*u})`).filter(t=>null!=t).call((t,a)=>{e.columns.forEach((a,e)=>{t.filter(t=>null!=t[a]).append("g").attr("transform",(t,a)=>`translate(${(e+.5)*r},${u/2})`).append("path").attr("d",t=>this.symbolGenerator.getPath(i,n(t[a]))).attr("fill",t=>o(a)).attr("class",s.controlData.bubble["Bubble style"].id).call(t=>{this.renderAttr(t,s.controlData.bubble["Bubble style"])}).append("title").text(t=>t[a])})})}})}drawTextLabel(){let t=this.layerPlaneData.layerStatistic["text map"]||[];console.log(t);let d=this.innerHeight/this.root.leaves().length;t.forEach((c,t)=>{if(c.isShowObj.isShow){let l=this.layerDataDict[c.layerDataFlieKey].dataIndex,a=this.layerDataDict[c.layerDataFlieKey].dataSource,t=this.root.leaves().filter(t=>(l.has(t.data.name)||console.log("mmnn9988",t.data.name),l.has(t.data.name))),r=c.layerDataColumnsIndex.map(t=>a.columns[t]),o=t.map(a=>{let e={};return r.forEach(t=>{e[t]=l.get(a.data.name)[t]}),e});o.columns=r,console.log(o);var h=c.controlData.canvas["Canvas scale"].width.value;let e=d3.scaleBand().domain(o.columns).range([0,h]),n=e.bandwidth();c.otherData.dragData||(c.otherData.dragData={x:0,y:0});let i=this.maingroup.append("g").attr("transform",t=>`translate(${this.maxLength+parseInt(c.controlData.canvas["Canvas scale"].x.value)},0)`).append("g").data([c.otherData.dragData]).attr("transform",t=>`translate(${t.x},${t.y})`).call(this.drag({enableY:!1})),s=d3.scaleOrdinal().domain(o.columns).range(0==c.categoryColorList.length?["#cccccc"]:c.categoryColorList);c.controlData.text["Custom color"].switch.value&&s.range(c.categoryList.map(t=>c.controlData.text["Custom color"][t].value)),this.addAxis(c.controlData,i,e),i.selectAll(".row").data(o).join("g").attr("transform",(t,a)=>`translate(0,${a*d})`).call((e,t)=>{o.columns.forEach((a,t)=>{e.filter(t=>null!=t[a]).append("text").attr("x",(t+.5)*n).attr("y",d/2).attr("dy","0.35em").attr("fill",t=>s(a)).attr("class",c.controlData.text["Text style"].id).call(t=>{this.renderAttr(t,c.controlData.text["Text style"])}).text(t=>t[a])})})}})}drawTextLabelCategory(){let t=this.layerPlaneData.layerStatistic["text map with category"]||[];console.log(t);let d=this.innerHeight/this.root.leaves().length;t.forEach((c,t)=>{if(c.isShowObj.isShow){let l=this.layerDataDict[c.layerDataFlieKey].dataIndex,a=this.layerDataDict[c.layerDataFlieKey].dataSource,t=this.root.leaves().filter(t=>l.has(t.data.name)),r=c.layerDataColumnsIndex.map(t=>a.columns[t]),o=t.map(a=>{let e={};return r.forEach(t=>{e[t]=l.get(a.data.name)[t]}),e});o.columns=r.slice(1),console.log(o);var h=c.controlData.canvas["Canvas scale"].width.value;let e=d3.scaleBand().domain(o.columns).range([0,h]),n=e.bandwidth();c.otherData.dragData||(c.otherData.dragData={x:0,y:0});let i=this.maingroup.append("g").attr("transform",t=>`translate(${this.maxLength+parseInt(c.controlData.canvas["Canvas scale"].x.value)},0)`).append("g").data([c.otherData.dragData]).attr("transform",t=>`translate(${t.x},${t.y})`).call(this.drag({enableY:!1})),s=d3.scaleOrdinal().domain(c.categoryList).range(0==c.categoryColorList.length?["#cccccc"]:c.categoryColorList);c.controlData.text["Custom color"].switch.value&&s.range(c.categoryList.map(t=>c.controlData.text["Custom color"][t].value)),c.colorScale=s,this.addAxis(c.controlData,i,e),i.selectAll(".row").data(o).join("g").attr("transform",(t,a)=>`translate(0,${a*d})`).call((e,t)=>{o.columns.forEach((a,t)=>{e.filter(t=>null!=t[a]).append("text").attr("x",(t+.5)*n).attr("y",d/2).attr("dy","0.35em").attr("fill",t=>s(t[r[0]])).attr("class",c.controlData.text["Text style"].id).call(t=>{this.renderAttr(t,c.controlData.text["Text style"])}).text(t=>t[a])})})}})}drawTextBlock(){const r=this;let t=r.layerPlaneData.layerStatistic["color block of leaves name"];t&&t.forEach((d,g)=>{var u=this.layerDataDict[d.layerDataFlieKey].dataSource;let m=this.layerDataDict[d.layerDataFlieKey].dataIndex,p=u.columns[d.layerDataColumnsIndex[0]],D=d3.scaleOrdinal().domain(d.categoryList).range(d.categoryColorList);if(d.isUseColorGradient&&D.range(d3.quantize(d3[d.colorInterpolate],D.domain().length)),d.controlData.color["Custom color"].switch.value&&D.range(d.categoryList.map(t=>d.controlData.color["Custom color"][t].value)),d.colorScale=D,this.maingroup.append("defs").selectAll(".gradient").data(d.categoryList).join("linearGradient").each(function(t,a){let e=d3.select(this);e.attr("id",t=>`cboln-${t.replaceAll("'","-").replaceAll(" ","-").trim()}-${g}`).attr("x1","100%").attr("x2","0%").attr("y1","50%").attr("y2","50%");let l=d.controlData.color["Color gradient"].reverse.value;"right to left"==r.horizontalLayout&&(l=!l),e.append("stop").attr("offset","0%").attr("stop-color",t=>D(t)).attr("stop-opacity",l?1:0),e.append("stop").attr("offset","50%").attr("stop-color",t=>D(t)).attr("stop-opacity",.3),e.append("stop").attr("offset","100%").attr("stop-color",t=>D(t)).attr("stop-opacity",l?0:1)}),console.log(d.categoryColorList),d.isShowObj.isShow){let l=[],r=void 0,o=1/0,n=null,i=this.root.leaves();function y(a,t){return t.every(t=>a.leaves().includes(t))?a:y(a.parent,t)}i.forEach((t,a)=>{let e=m.has(t.data.name)&&m.get(t.data.name)[p]||"";e!=r&&(l.push({name:e.toString(),start:a,end:0,node_arr:[]}),0<=l.length-2&&(l[l.length-2].end=a-1,l[l.length-2].LCA=y(n,l[l.length-2].node_arr),l[l.length-2].maxChidrenLength=d3.max(l[l.length-2].node_arr,t=>t.branchLength),l[l.length-2].minChidrenLength=d3.min(l[l.length-2].node_arr,t=>t.branchLength),o=t.depth,n=t)),l[l.length-1].node_arr.push(t),t.depth<o&&(o=t.depth,n=t),r=e,a==i.length-1&&(l[l.length-1].end=a,l[l.length-1].LCA=y(n,l[l.length-1].node_arr),l[l.length-1].maxChidrenLength=d3.max(l[l.length-1].node_arr,t=>t.branchLength),l[l.length-1].minChidrenLength=d3.min(l[l.length-1].node_arr,t=>t.branchLength))}),console.log("block_data",l),l=l.filter(t=>""!=t.name);let t=this.maingroup.append("g").lower(),s=this.innerHeight/i.length,c=d.controlData.block.block.width.value,a=d.controlData.block.block.padding.value;u=d.controlData.block.block["width-type"];let h=u.optionList[u.value];"uniform start and end"==h&&d.controlData.block["Tick text"].switch.value&&(console.log("Tick text"),t.append("g").attr("transform",`translate(${this.maxLength+d.controlData.block.block.x.value+c/2},${-d.controlData.block["Tick text"].offset.value})`).append("text").text(p).attr("class",d.controlData.block["Tick text"].id).attr("transform",`rotate(${-d.controlData.block["Tick text"].rotate.value})`).call(t=>{this.renderAttr(t,d.controlData.block["Tick text"])}));let e=[];"from branch tip to uniform end"==h&&(i.forEach((t,a)=>{m.has(t.data.name)&&m.get(t.data.name)[p]&&e.push({name:m.get(t.data.name)[p].toString(),start:a,end:a,branchLength:t.branchLength})}),console.log("from branch tip to uniform end",l)),t.selectAll("taxblock_t").data("from branch tip to uniform end"==h?e:l).join("g").attr("transform",t=>{if("uniform start and end"==h)return`translate(${"right to left"==this.horizontalLayout?-c-d.controlData.block.block.x.value:this.maxLength+d.controlData.block.block.x.value},0)`;if("from branch tip to uniform end"==h)return"right to left"==this.horizontalLayout?`translate(${-d.controlData.block.block["width-offset"].value})`:`translate(${t.branchLength},0)`;t="right to left"==this.horizontalLayout?t.minChidrenLength-d.controlData.block.block["width-offset"].value:t.LCA.branchLength-t.LCA.data.length*this.treeScale/2;return"right to left"==this.horizontalLayout&&"from LCA to uniform end"==h?`translate(${-d.controlData.block.block["width-offset"].value},0)`:`translate(${t},0)`}).append("rect").attr("class",`color-block-${g}`).attr("y",t=>t.start*s+a/2).attr("rx",d.controlData.block.block.rx.value).attr("ry",d.controlData.block.block.ry.value).attr("fill-opacity",d.controlData.block.block["fill-opacity"].value).attr("width",t=>"uniform start and end"==h?c:"from LCA to uniform end"==h?"right to left"==this.horizontalLayout?t.LCA.branchLength+t.LCA.data.length*this.treeScale/2+d.controlData.block.block["width-offset"].value:this.maxLength-(t.LCA.branchLength-t.LCA.data.length*this.treeScale/2)+d.controlData.block.block["width-offset"].value:"from branch tip to uniform end"==h?"right to left"==this.horizontalLayout?t.branchLength+d.controlData.block.block["width-offset"].value:this.maxLength-t.branchLength+d.controlData.block.block["width-offset"].value:"from LCA to max length of children"==h?"right to left"==this.horizontalLayout?t.LCA.branchLength-(t.minChidrenLength-t.LCA.data.length*this.treeScale/2)+d.controlData.block.block["width-offset"].value:t.maxChidrenLength-(t.LCA.branchLength-t.LCA.data.length*this.treeScale/2)+d.controlData.block.block["width-offset"].value:void 0).attr("height",t=>(t.end-t.start+1)*s-a).call(t=>{d.controlData.color["Color gradient"].switch.value?t.attr("fill",t=>`url('#cboln-${t.name.replaceAll("'","-").replaceAll(" ","-").trim()}-${g}')`):(t.attr("fill",t=>D(t.name)),"from branch tip to uniform end"==h&&t.clone().attr("fill","none").attr("stroke",t=>D(t.name))),"from branch tip to uniform end"!=h&&t.attr("stroke",t=>{let a=d.controlData.block.block.stroke.value;var e;return"stroke-type"in d.controlData.block.block&&("stroke as fill color"==(e=(e=d.controlData.block.block["stroke-type"]).optionList[e.value])&&(a=D(t.name)),"stroke as darker fill color"==e&&(a=d3.hsl(D(t.name)).darker(2))),a}).attr("stroke-width",d.controlData.block.block["stroke-width"].value)}),d.controlData.block.text.switch.value&&t.selectAll("taxblock_T").data(l).join("g").attr("transform",t=>{let a=this.maxLength+d.controlData.block.block.x.value+c,e=1;return"right to left"==this.horizontalLayout&&(a=-c-d.controlData.block.block.x.value,e=-1),"from LCA to uniform end"==h&&(a="right to left"==this.horizontalLayout?-d.controlData.block.block["width-offset"].value:this.maxLength+d.controlData.block.block["width-offset"].value),"from LCA to max length of children"==h&&(a="right to left"==this.horizontalLayout?t.minChidrenLength-d.controlData.block.block["width-offset"].value:t.maxChidrenLength+d.controlData.block.block["width-offset"].value),"from branch tip to uniform end"==h&&(a="right to left"==this.horizontalLayout?-d.controlData.block.block["width-offset"].value:this.maxLength+d.controlData.block.block["width-offset"].value),`translate(${e*d.controlData.block.text.x.value+a},${(t.start+t.end+1)/2*s})`}).append("text").attr("transform",t=>`rotate(${d.controlData.block.text.rotate.value})`).attr("class",d.controlData.block.text.id).attr("fill",t=>d.controlData.block.text["fill-as-block"].value?D(t.name):d.controlData.block.text.fill.value).attr("dy",".3em").attr("text-anchor",t=>90==d.controlData.block.text.rotate.value?"middle":"right to left"==this.horizontalLayout?"end":"start").text(t=>t.name).call(t=>{this.renderAttr(t,d.controlData.block.text)})}})}drawLengthAxis(){if(this.figureData["length axis"].Axis.switch.value){var e=this.maxLength/this.treeScale,l=this.figureData["length axis"].Axis["position-type"],r=l.optionList[l.value],o=this.figureData["length axis"].Tick["scale-by-factor"].value,n=this.figureData["length axis"].Tick["offset-value"].value;let t=this.figureData["length axis"].Tick.reverseValues.value;"right to left"==this.horizontalLayout&&(t=!t);let a=t?[n+e,n]:[n,n+e];0!=o&&(a[0]*=o,a[1]*=o),console.log("number",e);l=d3.scaleLinear().domain(a).range([0,this.innerwidth]),n=this.figureData["length axis"].Axis.offset.value,o=this.maingroup.append("g"),e={canvas:{"Canvas scale":{width:{value:this.innerwidth}}},xAxis:this.figureData["length axis"]};this.addAxis(e,o,l,"bottom"==r?"axisBottom":"axisTop",{vOffset:n})}}geologicTimeScale(){let t=this.layerPlaneData.layerStatistic["geologic time scale"]||[];t.forEach((s,t)=>{if(s.isShowObj.isShow){let t=this.layerDataDict[s.layerDataFlieKey].dataSource,[a,e,l]=t.columns.slice(1);var c=s.controlData.period.Position.offset.value;let r=this.maxLength/this.treeScale;var h=this.figureData["length axis"].Tick["scale-by-factor"].value;0!=h&&(r*=h);let o=d3.scaleLinear().domain("right to left"==this.horizontalLayout?[0,r]:[r,0]).range([0,this.innerwidth]),n=d3.scaleOrdinal().domain(s.categoryList).range(s.categoryColorList);s.controlData.period["Custom color"].switch.value&&n.range(s.categoryList.map(t=>s.controlData.period["Custom color"][t].value));let i=this.maingroup.append("g").attr("transform",`translate(0,${this.innerHeight+c})`).append("g").data([s.otherData.dragData]).attr("transform",t=>`translate(${t.x},${t.y})`).call(this.drag({enableX:!1})).selectAll("periodRect").data(t).join("g").attr("transform",t=>`translate(${o(t["right to left"==this.horizontalLayout?l:e])},0)`);i.append("rect").attr("class",s.controlData.period["Period style"].id).attr("width",t=>Math.abs(o(t[l])-o(t[e]))).attr("height",s.controlData.period["Period style"].height.value).attr("fill",t=>n(t[a])).call(t=>{this.renderAttr(t,s.controlData.period["Period style"])}),i.append("text").attr("class",s.controlData.period["Text style"].id).text(t=>t[a]).attr("x",t=>Math.abs(o(t[l])-o(t[e]))/2).attr("y",s.controlData.period["Period style"].height.value/2).attr("dy","0.35em").attr("text-anchor","middle").call(t=>{this.renderAttr(t,s.controlData.period["Text style"])})}})}drawRecombinationFragmentMap(){let t=this.layerPlaneData.layerStatistic["recombination fragment map"]||[];t.forEach((s,t)=>{if(s.isShowObj.isShow){let t=this.layerDataDict[s.layerDataFlieKey].dataSource,[a,e,l]=t.columns.slice(1),r=d3.group(t,t=>t[a]);var c=d3.max(t,t=>t[l]),h=s.controlData.canvas["Canvas scale"].width.value;let o=d3.scaleLinear().domain([0,c]).range([0,h]),n=this.maingroup.append("g").attr("transform",t=>`translate(${this.maxLength+parseInt(s.controlData.canvas["Canvas scale"].x.value)},0)`);this.addAxis(s.controlData,n,o);let i={};this.root.descendants().forEach(t=>{var a;r.has(t.data.uniformNodeId)&&(a=d3.extent(t.leaves(),t=>t.x),i[t.data.uniformNodeId]={start:a[0],height:a[1]-a[0]})}),n.append("g").selectAll("NodeG").data(Object.keys(i)).join("g").attr("transform",t=>`translate(0,${i[t].start})`).selectAll("fragmentRect").data(t=>r.get(t)).join("rect").attr("height",t=>i[t[a]].height).attr("width",t=>o(t[l])-o(t[e])).attr("x",t=>o(t[e])).attr("fill","red"),console.log("drawRecombinationFragmentMap",i)}})}addAxis(a,t,e,l="axisTop",{vOffset:r}={}){if(a.xAxis.Axis){if(!a.xAxis.Axis.switch.value)return;var o;"position-type"in a.xAxis.Axis&&(o=a.xAxis.Axis["position-type"],l="bottom"==o.optionList[o.value]?"axisBottom":"axisTop",r=a.xAxis.Axis.offset.value)}a.background&&a.background.Background.switch.value&&t.insert("rect","#maingroup g:nth-child(1)").attr("class",a.background.Background.id).attr("width",a.canvas["Canvas scale"].width.value).attr("height",this.innerHeight).call(t=>{this.renderAttr(t,a.background.Background)});const n=a.xAxis.Tick,i=d3[l](e);n.hasOwnProperty("tickValues")&&n.tickValues.value?i.tickValues(n.tickValues.value.split(",")):"l"==e.name&&i.ticks(Math.floor(a.canvas["Canvas scale"].width.value/50)),console.log("xAxis",i),console.log("xScale",e.name),n.hasOwnProperty("tickFormat")&&n.tickFormat.value&&i.tickFormat(d3.format(`${n.tickFormat.value}`));const s=t.append("g").call(i).attr("id","xAxis").attr("font-family",null);r*="axisBottom"==l?-1:1,"axisBottom"==l?s.attr("transform",`translate(0,${this.innerHeight+r})`):s.attr("transform",`translate(0,${r})`);e=a.xAxis["Text style"];s.selectAll(".tick text").remove(),e.switch.value&&(t=s.selectAll(".tick").append("g").attr("transform",t=>`translate(0,${("axisBottom"==l?-1:1)*a.xAxis["Text style"].offset.value})`).append("text").text(t=>n.hasOwnProperty("tickFormat")&&n.tickFormat.value?d3.format(`${n.tickFormat.value}`)(t):t).attr("class",e.id).attr("dy","0.35em"),n.hasOwnProperty("tickFormat")&&n.tickFormat.value.endsWith("E")&&s.selectAll(".tick text").call(t=>{this.valueFormat(t,n.tickFormat.value)}),this.renderAttr(t,e));e=s.append("g").attr("transform",`translate(${a.canvas["Canvas scale"].width.value/2},0)`).append("text").attr("class",a.xAxis.Label.id).attr("text-anchor","middle");this.renderAttr(e,a.xAxis.Label),this.renderText(e,a.xAxis.Label.text.value),s.selectAll(".tick line").attr("class","tick-line").call(t=>{this.renderAttr(t,n)}),n.hasOwnProperty("tickFormat")&&n.tickFormat.value.endsWith("E")&&s.selectAll(".tick text").call(t=>{this.valueFormat(t,n.tickFormat.value)}),a.xAxis.Grid&&a.xAxis.Grid.switch.value&&(r=s.selectAll(".tick line").clone().attr("class",a.xAxis.Grid.id).attr("y2",("axisBottom"==l?-this.innerHeight:this.innerHeight)-(r||0)),this.renderAttr(r,a.xAxis.Grid)),s.selectAll(".domain").call(t=>{this.renderAttr(t,n)}).raise(),a.xAxis.Tick.removePath.value&&s.selectAll(".domain").remove(),a.xAxis.Tick.removeTick.value&&s.selectAll(".tick .tick-line").remove()}}window.normalTree=new NormalTree,normalTree.setExampleData(["/static/Ali/data/NJ_tree.treefile"]);let queryParams=new URLSearchParams(window.location.search);if(queryParams.has("originalJsonDataUri")){let t=queryParams.get("originalJsonDataUri")+`?v=${Math.random()}`;d3.json(t).then(t=>{normalTree.importOriginalJsonData(t),d3.select("#page-loading-box").remove()}).catch(t=>{console.log(t),normalTree.showMessageBox("cuIcon-roundclose","No such json file!","error"),d3.select("#page-loading-box").remove()})}else d3.text("/static/Ali/data/NJ_tree.treefile").then(function(t){normalTree.onLoadNewFile(t),d3.select("#page-loading-box").remove()});