import{ScatterPlot}from"/static/xiaochiPlot/js/scatter.js";class RDAPlot extends ScatterPlot{constructor(t="pcoa"){super(["modify shape and color","change shape only","add label","top density plot","right density plot","size of points","gradient color of points"]),this.RDAType=t,this.plotType=t,this.styleData.stressTextDragData={x:400,y:100},this.creatVueApp()}init(){null!=this.pcoaData&&(this.zoomG.text(""),super.init(),this.xScale=d3.scaleLinear().domain([this.figureData.xAxis.Tick["min-value"].value,this.figureData.xAxis.Tick["max-value"].value]).range([0,this.innerwidth]),this.yScale=d3.scaleLinear().domain([this.figureData.yAxis.Tick["max-value"].value,this.figureData.yAxis.Tick["min-value"].value]).range([0,this.innerHeight]),this.addAxis(),this.drawScatter(this.pcoaData.scatterData,this.figureData[this.RDAType]),this.drawTopDensity(this.pcoaData.scatterData),this.drawRightDensity(this.pcoaData.scatterData),"nmds"==this.RDAType&&this.drawStressText(),this.drawTitle(),this.drawLegend(),this.setGlobalFontStyle())}async onLoadNewFile(o,t,a){if(console.log(a),console.log(o),"local"==t||"originalJsonData"==t){if(this.fileName=a,this.pcoaData=null,await this.getUserFigureData("/xiaochi/gettoken"),o.columns.length<3)return void this.showMessageBox("cuIcon-roundclose","Feature columns are lower than 2!","error");let i=!1,s=0;if(o.forEach((a,t)=>{let e=0;o.columns.slice(1).forEach(t=>{e+=a[t]}),0==e&&(i=!0,s+=1)}),Array.from(new Set(o.map(t=>t[o.columns[0]]))).length<o.length)return void this.showMessageBox("cuIcon-roundclose","Found duplicate IDs in 1st columns!","error");if(i)return void this.showMessageBox("cuIcon-roundclose",`Contain ${s} row${1<s?"s":""} with all values are 0!`,"error");await this.uploadUserData(d3.tsvFormat(o,o.columns),"xjm",`${a}.tsv`);a=await this.reDoPCoA();this.pcoaData=a,"local"==t&&(this.styleData.pointTextDragData={},this.pcoaData.scatterData.forEach(t=>{this.styleData.pointTextDragData[t.sample]={x:0,y:0,name:t.sample}}))}"web"==t&&(this.pcoaData=o,i=d3.extent(this.pcoaData.scatterData,t=>t.PC1),e=d3.extent(this.pcoaData.scatterData,t=>t.PC2),this.figureData.xAxis.Tick["min-value"].value=1.1*i[0],this.figureData.xAxis.Tick["max-value"].value=1.1*i[1],this.figureData.yAxis.Tick["min-value"].value=1.1*e[0],this.figureData.yAxis.Tick["max-value"].value=1.1*e[1]);var e,i={pcoa:"PCo",pca:"PC",nmds:"NMDS"};"nmds"==this.RDAType?(this.figureData.xAxis.Label.text.value=`${i[this.RDAType]}1`,this.figureData.yAxis.Label.text.value=`${i[this.RDAType]}2`):(this.figureData.xAxis.Label.text.value=`${i[this.RDAType]}1: ${Math.round(1e4*this.pcoaData.proportion_explained[0])/100}%`,this.figureData.yAxis.Label.text.value=`${i[this.RDAType]}2: ${Math.round(1e4*this.pcoaData.proportion_explained[1])/100}%`),"local"==t&&(e=d3.extent(this.pcoaData.scatterData,t=>t.PC1),i=d3.extent(this.pcoaData.scatterData,t=>t.PC2),this.figureData.xAxis.Tick["min-value"]={type:"seq",value:1.1*e[0],isSvgAttr:!1,scaleStep:.01,min:-1/0,max:e[0]},this.figureData.xAxis.Tick["max-value"]={type:"seq",value:1.1*e[1],isSvgAttr:!1,scaleStep:.01,min:e[1],max:1/0},this.figureData.yAxis.Tick["min-value"]={type:"seq",value:1.1*i[0],isSvgAttr:!1,scaleStep:.01,min:-1/0,max:i[0]},this.figureData.yAxis.Tick["max-value"]={type:"seq",value:1.1*i[1],isSvgAttr:!1,scaleStep:.01,min:i[1],max:1/0},this.Vue.$refs.controlPlane.$data.controlList[0]=this.dictToControlList(this.figureData)),"originalJsonData"!=t&&this.init()}creatVueApp(){const e=this;this.figureData.data["data file"][`${this.RDAType}-result`]={type:"button",value:"",event:"viewRDAData",isBGGray:!1,isFresh:!1,iconClass:"cuIcon-attentionfill"},this.figureData[this.RDAType]={algorithm:{distance:{type:"opt",optionList:["braycurtis","canberra","chebyshev","cityblock","correlation","cosine","euclidean","hamming","jaccard","jensenshannon","kulsinski","mahalanobis","matching","minkowski","rogerstanimoto","russellrao","seuclidean","sokalmichener","sokalsneath","sqeuclidean"],value:0,isSvgAttr:!1},standardization:{type:"opt",optionList:["None","PercentScaler","StandardScaler","MinMaxScaler","MaxAbsScaler","RobustScaler"],value:0,isSvgAttr:!1},"std-direction":{type:"opt",optionList:["column","row"],value:0,isSvgAttr:!1},refresh:{type:"button",value:"",event:"reDoPCoA",isFresh:!1,iconClass:"cuIcon-refresh"}},"center line":{switch:{type:"check",value:!0,isFresh:!0},stroke:{type:"color",value:"#000000",isSvgAttr:!0},"stroke-width":{type:"seq",value:1,isSvgAttr:!0,scaleStep:1,min:0,max:1/0},"stroke-opacity":{type:"seq",value:.4,isSvgAttr:!0,scaleStep:.01,min:0,max:1}},"point style":{type:{type:"opt",optionList:["symbolCircle-fill","symbolCircle-nofill","symbolCross-fill","symbolCross-nofill","symbolDiamond-fill","symbolDiamond-nofill","symbolSquare-fill","symbolSquare-nofill","symbolStar-fill","symbolStar-nofill","symbolTriangle-fill","symbolTriangle-nofill","symbolWye-fill","symbolWye-nofill","symbolDownTriangle-fill","symbolDownTriangle-nofill"],value:0,isSvgAttr:!1},fill:{type:"color",value:"#7c8fd2",isSvgAttr:!1},"gradient-color":{type:"check",value:!1,isFresh:!0},"stroke-as-fill":{type:"check",value:!0,isFresh:!0},stroke:{type:"color",value:"#000000",isSvgAttr:!1},"stroke-width":{type:"seq",value:1,isSvgAttr:!0,scaleStep:1,min:0,max:1/0},"fill-opacity":{type:"seq",value:1,isSvgAttr:!0,scaleStep:.01,min:0,max:1},size:{type:"seq",value:40,isSvgAttr:!1,scaleStep:1,min:30,max:1/0}},"point text":{id:"point-text-style",switch:{type:"check",value:!1,isFresh:!0},"font-size":{type:"seq",value:14,isSvgAttr:!0,scaleStep:1,min:0,max:1/0},"font-weight":{type:"opt",optionList:["normal","bold"],value:0,isSvgAttr:!0},"text-anchor":{type:"opt",optionList:["start","middle","end"],value:1,isSvgAttr:!0},"font-style":{type:"opt",optionList:["normal","italic"],value:0,isSvgAttr:!0},fill:{type:"color",value:"#000000",isSvgAttr:!0},"fill-opacity":{type:"seq",value:.4,isSvgAttr:!0,scaleStep:.01,min:0,max:1},dx:{type:"seq",value:0,isSvgAttr:!0,scaleStep:1,min:-1/0,max:1/0},dy:{type:"seq",value:-6,isSvgAttr:!0,scaleStep:1,min:-1/0,max:1/0}}},"pca"==this.RDAType&&delete this.figureData[this.RDAType].algorithm.distance,"nmds"==this.RDAType&&(this.figureData[this.RDAType].algorithm.distance.optionList=["bray","euclidean","manhattan","canberra","clark","kulczynski","jaccard","gower","altGower","morisita","horn","mountford","raup","binomial","chao","cao","mahalanobis","chisq","chord","hellinger","aitchison"],this.figureData[this.RDAType].algorithm.standardization.optionList=["None","PercentScaler","StandardScaler","MinMaxScaler","MaxAbsScaler"],this.figureData[this.RDAType].stress={id:"stress-text-style",switch:{type:"check",value:!0,isFresh:!0},"font-size":{type:"seq",value:16,isSvgAttr:!0,scaleStep:1,min:0,max:1/0},"font-weight":{type:"opt",optionList:["normal","bold"],value:0,isSvgAttr:!0},"text-anchor":{type:"opt",optionList:["start","middle","end"],value:1,isSvgAttr:!0},"font-style":{type:"opt",optionList:["normal","italic"],value:0,isSvgAttr:!0},fill:{type:"color",value:"#000000",isSvgAttr:!0},"fill-opacity":{type:"seq",value:1,isSvgAttr:!0,scaleStep:.01,min:0,max:1}}),this.figureData.xAxis.Tick.tickSizeOuter.value=!0,this.figureData.yAxis.Tick.tickSizeOuter.value=!0,super.creatVueApp(),this.handleClickMethods.reDoPCoA=function(){e.reDoPCoA().then(t=>{e.onLoadNewFile(t,"web")})},this.handleClickMethods.viewRDAData=function(t){if(!e.pcoaData)return e.showMessageBox("cuIcon-roundclose","No layer data!","error"),void e.shakeElement(t);let a=[{fileName:`${e.RDAType}_result`,type:"tsvStr",fileData:d3.tsvFormat(e.pcoaData.scatterData,e.pcoaData.scatterData.columns)}];"pca"==e.RDAType&&a.push({fileName:"loading_scores",type:"tsvStr",fileData:e.pcoaData.loadingScores}),window.localStorage.setItem("RDADataArr",JSON.stringify(a)),window.open("/static/xiaochiPlot/src/exampleData.html?type=localStorage&source=RDADataArr")}}drawStressText(){this.figureData[this.RDAType].stress.switch.value&&this.zoomG.append("g").data([this.styleData.stressTextDragData]).attr("transform",t=>`translate(${t.x},${t.y})`).call(this.drag()).append("text").attr("class",this.figureData[this.RDAType].stress.id).text(`Stress = ${d3.format(".3r")(this.pcoaData.stress)}`).call(t=>{this.renderAttr(t,this.figureData[this.RDAType].stress)})}async reDoPCoA(){var t=this,a=t.figureData[t.RDAType].algorithm.distance,e=a?a.optionList[a.value]:"None",i=t.figureData[t.RDAType].algorithm.standardization,a=i.optionList[i.value],i=t.figureData[t.RDAType].algorithm["std-direction"],i=i.optionList[i.value];let s=await t.getUserFigureData(`/ChiPlot/RDA?t=${t.RDAType}&d=${e}&s=${a}&fileName=${t.fileName}.tsv&stdDirection=${i}`);return s.scatterData=d3.tsvParse(s.scatterData,d3.autoType),s.scatterData.forEach(t=>{t.sample=t.sample.toString()}),s}}export{RDAPlot};