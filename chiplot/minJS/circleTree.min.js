import{MainTree,maxLength,getNodeHeight}from"/chiplot/minJS/mainTree.min.js";import{BarPlot}from"/chiplot/js/barPlot.js";import{splitPath}from"/chiplot/js/splitPath.js";class NormalTree extends MainTree{constructor(){super("treefile"),this.barPlot=new BarPlot(this),this.plotType="circleTree",this.creatVueApp()}init(t,a,e){var l;"attrChanged"==t&&"Branches sorting"==e||"originalJsonData"==t?this.reRootTree(this.styleData.rootNodeIndex,this.styleData.rootOffsetRate):("attrChanged"==t&&"data-source"==a&&"Bootstraps"==e&&(l=(l=this.figureData.branches.Bootstraps["data-source"]).optionList[l.value],console.log(99999,l),l in this.btRangeDict?(console.log(this.btRangeDict[l]),this.figureData.branches.Bootstraps.from.value=this.btRangeDict[l][0],this.figureData.branches.Bootstraps.to.value=this.btRangeDict[l][1]):(this.figureData.branches.Bootstraps.from.value=0,this.figureData.branches.Bootstraps.to.value=0),this.Vue.$refs.controlPlane.$forceUpdate()),this.zoomG.text(""),super.init(t),this.outerRadius=this.innerwidth/2,console.log("this.outerRadius",this.outerRadius),this.polarGroup=this.maingroup.append("g").attr("transform",`translate(${this.innerwidth/2},${this.innerHeight/2})`).attr("id","polarGroup"),this.treeStartAngle=this.figureData.leaves["Circle size"].startAngle.value,this.absoluteStartAngle=this.figureData.leaves["Circle size"].startAngle.value,this.treeEndAngle=this.figureData.leaves["Circle size"].endAngle.value,this.treeAngleRange=this.treeEndAngle-this.absoluteStartAngle,this.root=d3.cluster().size([this.treeEndAngle-this.treeStartAngle,this.outerRadius]).separation((t,a)=>1)(this.treeHierarchy),l=this.figureData.branches.Branches["show-root"].value,void 0!==this.rootLength&&l?this.root.data.length=this.rootLength:this.root.data.length=0,this.treeStartAngle-=90,this.inwardLayoutInnerRadius=this.figureData.branches["Inward layout"].innerRadius.value,this.isInwardLayout=this.figureData.branches["Inward layout"].switch.value,this.treeScale=parseFloat(this.isInwardLayout?this.outerRadius-this.inwardLayoutInnerRadius:this.outerRadius)/parseFloat(maxLength(this.root.data,this.figureData.branches.Branches["ignore-length"].value)),t=getNodeHeight(this.root),this.setRadius(this.root,0,this.treeScale,t+(l?0:-1),t+(l?1:0)),this.maxLength=this.outerRadius,console.log(this.root),this.drawLengthAxis(),this.geologicTimeScale(),this.drawTree(),this.drawNodeAges("circle"),this.drawCollapseClade(),this.drawTextBlock(),this.drawPieChart("circle"),this.drawBranchPieChart("circle"),this.drawBarPlot(),this.drawBaseBarPlot(),this.drawMotifMEME(),this.drawBaseLollipopPlot(),this.drawBaseLollipopPlotCategory(),this.drawLinks(),this.drawSymbol("circle"),this.drawHeatmap(),this.drawStackedBarPlot(),this.drawBoxPlot(),this.drawBoxPlotCategory(),this.drawBinary(),this.drawBinary2(),this.drawBubblePlot(),this.drawTextLabel(),this.drawTextLabelCategory(),this.drawBranchTextLabel("circle"),this.colorBranch(),this.drawLegend(),this.setGlobalFontStyle())}drawTree(){const i=this;let l=this.isInwardLayout;function r(t,a,e,l){var r=Math.cos(t=(t+i.treeStartAngle)/180*Math.PI),o=Math.sin(t),n=Math.cos(e=(e+i.treeStartAngle)/180*Math.PI),s=Math.sin(e);return"M"+a*r+","+a*o+(e===t?"":"A"+a+","+a+` 0 ${Math.abs(e-t)>Math.PI?1:0} `+(t<e?1:0)+" "+a*n+","+a*s)+"L"+l*n+","+l*s}let o=this.outerRadius/getNodeHeight(this.root);var a=this.figureData.branches.Branches["link-type"];let e=a.optionList[a.value],t=this.root.links();t.push({source:{radius:l?this.outerRadius:0,x:this.root.x,absoluteStartAngle:this.root.absoluteStartAngle},target:this.root});let n=this.figureData.branches.Branches;this.polarGroup.append("g").attr("fill","none").selectAll("branchpath").data(t).join("path").attr("d",t=>function(t,a){let e=i.figureData.branches.Branches["ignore-length"].value&&t.target.data.isCollapse?o:0,l={rectangular:function(t){return r(t.source.x,t.source.radius,t.target.x,t.target.radius-e)},"rounded rectangular":function(t){return r(t.source.x,t.source.radius,t.target.x,t.target.radius-e)},linear:function(t){let a=d3.lineRadial().radius(t=>t.radius).angle(t=>t.angle);t=[{angle:t.source.absoluteStartAngle*Math.PI/180,radius:t.source.radius},{angle:t.target.absoluteStartAngle*Math.PI/180,radius:t.target.radius-e}];return a(t)},elliptical:function(t){let a=d3.lineRadial().radius(t=>t.radius).angle(t=>t.angle).curve(d3.curveBundle.beta(.85));t=[{angle:t.source.absoluteStartAngle*Math.PI/180,radius:t.source.radius},{angle:t.target.absoluteStartAngle*Math.PI/180,radius:t.source.radius},{angle:t.target.absoluteStartAngle*Math.PI/180,radius:t.target.radius-e}];return a(t)},bezierX:function(t){let a=d3.lineRadial().radius(t=>t.radius).angle(t=>t.angle).curve(d3.curveBumpX);t=[{angle:t.source.absoluteStartAngle*Math.PI/180,radius:t.source.radius},{angle:t.target.absoluteStartAngle*Math.PI/180,radius:t.target.radius-e}];return a(t)},bezierY:function(t){let a=d3.lineRadial().radius(t=>t.radius).angle(t=>t.angle).curve(d3.curveBumpY);t=[{angle:t.source.absoluteStartAngle*Math.PI/180,radius:t.source.radius},{angle:t.target.absoluteStartAngle*Math.PI/180,radius:t.target.radius-e}];return a(t)}};return l[a](t)}(t,e)).attr("class",n.id).attr("stroke",n.stroke.value).call(t=>{this.renderAttr(t,n)}).on("click",this.treeBranchClickFunction()).on("mouseenter",this.treeBranchEnterFunction()).on("mouseleave",this.treeBranchleaveFunction()),d3.max(this.root.leaves(),t=>(null==t.data.name&&console.log("llll",t),t.data.name.length));let s=this.figureData.leaves["Leaves Extension"].extension.value;s&&this.polarGroup.append("g").attr("fill","none").selectAll("path").data(this.root.links().filter(t=>!t.target.children)).join("path").attr("class",this.figureData.leaves["Leaves Extension"].id).attr("d",function(t){let a=i.outerRadius;return l&&(a=i.inwardLayoutInnerRadius),r(t.target.x,t.target.radius,t.target.x,a)}).call(t=>{this.renderAttr(t,this.figureData.leaves["Leaves Extension"])});let c=this.figureData.leaves["Text style"].x.value*(l?-1:1);this.polarGroup.append("g").selectAll("leaftext").data(this.root.leaves()).join("g").attr("transform",t=>{var a=t.data.isCollapse&&!this.figureData.branches.Branches["ignore-length"].value?t.data.lengthMMV[1]*this.treeScale:0;let e=s?this.outerRadius+c:t.radius+a+c;return l&&s&&(e=this.inwardLayoutInnerRadius+c),`rotate(${t.x+this.treeStartAngle}) translate(${e},0)${t.absoluteStartAngle<180?"":" rotate(180)"}`}).append("text").attr("dy",".35em").attr("text-anchor",t=>l?180<t.absoluteStartAngle?"start":"end":t.absoluteStartAngle<180?"start":"end").attr("class",this.figureData.leaves["Text style"].id).call(t=>{this.drawLeafText(t,"circle")});let d;var u=this.figureData.branches.Bootstraps.type;let h=u.optionList[u.value];a=this.figureData.branches.Bootstraps["data-source"];let g=a.optionList[a.value],m=this.Vue.$refs.controlPlane.$data.controlList[0];u=m.findIndex(t=>"BT legend"==t.tabName),a=m.findIndex(t=>"BT color bar legend"==t.tabName);this.figureData.branches.Bootstraps.switch.value&&"None"!=g?d=this.polarGroup.append("g").selectAll("bt").data(this.root.descendants().filter(t=>t.children)).join("g").attr("transform",t=>`rotate(${t.x+this.treeStartAngle})translate(${t.radius},0)${t.absoluteStartAngle<180?"":" rotate(180)"}`):(h="None",m[u].isDisplay=!1,m[a].isDisplay=!1);let p=i.figureData.branches.Bootstraps;if("text"==h&&(m[u].isDisplay=!1,m[a].isDisplay=!1,d.each(function(t,a){let e=d3.select(this),l=0;"bootstrap"==g&&"btArr"in t.data?l=t.data.btArr[0]:g in i.btRangeDict&&"otherProperty_L"in t.data&&(l=t.data.otherProperty_L[g]),l>=p.from.value&&l<=p.to.value&&(l*=p["scale-by-factor"].value,l=Number(l.toFixed(10)),t=0==p["round-decimals"].value&&l<1?l:d3.format(`.${p["round-decimals"].value}f`)(l),e.selectAll("BTG").data([i.btDragData[a]]).join("g").attr("transform",t=>`translate(${t.x},${t.y})`).call(i.drag()).append("text").attr("class",p.id).text(0!=t?t:"").call(t=>{i.renderAttr(t,p)}))})),"circle"==h&&(m[u].isDisplay=!0,m[a].isDisplay=!1,d.filter(t=>"bootstrap"==g&&"btArr"in t.data&&70<=t.data.btArr[0]*p["scale-by-factor"].value).append("path").attr("d",t=>d3.symbol().type(d3.symbolCircle).size(this.figureData.branches.Bootstraps["circle-size"].value)()).attr("fill",t=>90<t.data.btArr[0]*p["scale-by-factor"].value?"black":70<=t.data.btArr[0]*p["scale-by-factor"].value&&t.data.btArr[0]*p["scale-by-factor"].value<=90?"#aaaaaa":void 0)),"gradient color circle"==h){m[u].isDisplay=!1,m[a].isDisplay=!0;u=this.figureData["BT color bar legend"]["ColorBar range"];let t=[...this.btRangeDict[g]];a=u["max-value"].value;""!=a&&(t[1]=Number(a));a=u["min-value"].value;""!=a&&(t[0]=Number(a)),this.mmvBTvalue=t;let e=d3.scaleSequential(u.reverse.value?[t[1],t[0]]:t,d3[this.styleData.currentColorInterpolate]);u["median-value"].value&&(a=Number(u["median-value"].value),e=d3.scaleSequential(u.reverse.value?[t[1],a,t[0]]:[t[0],a,t[1]],d3[this.styleData.currentColorInterpolate])),d.filter(t=>{let a=0;return"bootstrap"==g&&"btArr"in t.data&&0<t.data.btArr.length?a=t.data.btArr[0]:g in i.btRangeDict&&"otherProperty_L"in t.data&&(a=t.data.otherProperty_L[g]),0!=a}).append("g").append("path").attr("d",t=>d3.symbol().type(d3.symbolCircle).size(this.figureData.branches.Bootstraps["circle-size"].value)()).attr("stroke-width",1).attr("stroke","#000000").attr("fill",t=>{let a=0;return"bootstrap"==g&&"btArr"in t.data?a=t.data.btArr[0]:g in i.btRangeDict&&"otherProperty_L"in t.data&&(a=t.data.otherProperty_L[g]),e(a)})}if("Branches length"in this.figureData.branches&&this.figureData.branches["Branches length"].switch.value){const v=this.figureData.branches["Branches length"],f=this.figureData.branches["Inward layout"].switch.value?-1:1;this.polarGroup.append("g").selectAll("bt").data(this.root.descendants()).join("g").attr("transform",t=>`rotate(${t.x+this.treeStartAngle})translate(${t.radius},0)${t.absoluteStartAngle<180?"":" rotate(180)"}`).append("g").attr("transform",t=>`translate(${(t.absoluteStartAngle<180?-1:1)*f*this.treeScale*t.data.length/2},0)`).append("text").text(t=>{return console.log(t),0==v["round-decimals"].value?t.data.length:d3.format(`.${v["round-decimals"].value}f`)(t.data.length)}).attr("class",this.figureData.branches["Branches length"].id).call(t=>{this.renderAttr(t,this.figureData.branches["Branches length"])})}}drawCollapseClade(){let t=this.root.leaves();var a=t.filter(t=>t.data.isCollapse);let l=this.treeAngleRange/t.length/2;this.figureData.branches.Branches;let r=d3.lineRadial().radius(t=>t.radius).angle(t=>t.angle);this.polarGroup.append("g").selectAll("cladePath").data(a).join("path").attr("class",this.figureData["folded clade"]["Clade style"].id).attr("d",t=>{var a=t.data.lengthMMV,e=this.outerRadius/getNodeHeight(this.root);return this.figureData.branches.Branches["ignore-length"].value?r([{radius:t.radius-e,angle:t.absoluteStartAngle*Math.PI/180},{radius:t.radius,angle:(t.absoluteStartAngle-l)*Math.PI/180},{radius:t.radius,angle:(t.absoluteStartAngle+l)*Math.PI/180}])+"Z":r([{radius:t.radius,angle:t.absoluteStartAngle*Math.PI/180},{radius:t.radius+a[0]*this.treeScale,angle:(t.absoluteStartAngle-l)*Math.PI/180},{radius:t.radius+a[1]*this.treeScale,angle:(t.absoluteStartAngle+l)*Math.PI/180}])+"Z"}).attr("fill",t=>(this.figureData["folded clade"]["Custom color"].switch.value?this.figureData["folded clade"]["Custom color"][t.data.name]:this.figureData["folded clade"]["Clade style"].fill).value).attr("stroke",t=>(this.figureData["folded clade"]["Clade style"]["stroke-as-fill"].value?this.figureData["folded clade"]["Custom color"].switch.value?this.figureData["folded clade"]["Custom color"][t.data.name]:this.figureData["folded clade"]["Clade style"].fill:this.figureData["folded clade"]["Clade style"].stroke).value).call(t=>{this.renderAttr(t,this.figureData["folded clade"]["Clade style"])}).on("mouseenter",this.treeBranchEnterFunction("foldedClade")).on("mouseleave",this.treeBranchleaveFunction("foldedClade")).on("click",this.treeBranchClickFunction("foldedClade"))}drawBarPlot(){let t=this.layerPlaneData.layerStatistic["bar plot with category"]||[];console.log("bar"),console.log(t),t.forEach((h,t)=>{if(h.isShowObj.isShow){var g=this.layerDataDict[h.layerDataFlieKey].dataSource;let l=this.layerDataDict[h.layerDataFlieKey].dataIndex,r=g.columns[h.layerDataColumnsIndex[1]],a=g.columns[h.layerDataColumnsIndex[0]];var m=h.controlData.canvas["Canvas scale"].width.value;let e=h.controlData.canvas["Canvas scale"].x.value,o=2*(this.outerRadius+e)*Math.PI/this.root.leaves().length*(1-h.controlData.bar["Bar style"].padding.value)*this.treeAngleRange/360,n=[],t=this.root.leaves().filter(t=>{var a=l.has(t.data.name)&&l.get(t.data.name)[r];return a&&n.push(l.get(t.data.name)[r]),a});var[p,g]=d3.extent(n);let s=d3.scaleLinear().domain(p<0?[p,g]:[0,g]).range([0,m]),i=this.polarGroup.append("g"),c=d3.scaleOrdinal().domain(h.categoryList).range(h.categoryColorList);h.controlData.bar["Custom color"].switch.value&&(m=h.categoryList.map(t=>h.controlData.bar["Custom color"][t].value),console.log(m),c.range(m)),h.colorScale=c;let d=t.map(t=>{return{barStart:t.x-o/2,barWidth:o,barHeight:s(l.get(t.data.name)[r]),fill:c(l.get(t.data.name)[a]),text:l.get(t.data.name)[r],textY:s(l.get(t.data.name)[r])+10,textX:o/2}});d.barStyle=h.controlData.bar["Bar style"],d.textStyle=h.controlData.bar["Bar text"],d.initType=null,this.addAxis(h.controlData,i,s);let u=i.selectAll("newBar").data(t).join("g").attr("transform",t=>`rotate(${t.x+this.treeStartAngle}) translate(${this.outerRadius+e},0)`);if(u.append("rect").attr("width",t=>Math.abs(s(l.get(t.data.name)[r])-s(0))).attr("height",o).attr("y",-o/2).attr("x",t=>l.get(t.data.name)[r]<0?s(l.get(t.data.name)[r]):s(0)).attr("fill",t=>c(l.get(t.data.name)[a])).attr("class",h.controlData.bar["Bar style"].id).call(t=>{this.renderAttr(t,h.controlData.bar["Bar style"])}),h.controlData.bar["Bar text"].switch.value){let e=h.controlData.bar["Bar text"];u.append("g").attr("transform",t=>e.align&&e.align.value?`${t.absoluteStartAngle<180?"rotate(0)":"rotate(180)"}`:t.absoluteStartAngle<180?`translate(${s(l.get(t.data.name)[r])},0)`:`translate(${s(l.get(t.data.name)[r])},0) rotate(180)`).append("text").text(t=>{let a=l.get(t.data.name)[r];return e["value-format"]&&e["value-format"].value&&(a=d3.format(e["value-format"].value)(a)),a}).attr("text-anchor",t=>0<l.get(t.data.name)[r]?t.absoluteStartAngle<180?"start":"end":180<t.absoluteStartAngle?"start":"end").attr("x",t=>0<l.get(t.data.name)[r]?t.absoluteStartAngle<180?e.x.value:-e.x.value:180<t.absoluteStartAngle?e.x.value:-e.x.value).attr("class",e.id).attr("dy","0.35em").call(t=>{this.renderAttr(t,e)})}}})}drawMotifMEME(){const p=this;let t=p.layerPlaneData.layerStatistic["motif MEME"]||[];t.forEach((d,t)=>{if(d.isShowObj.isShow){let t=this.layerDataDict[d.layerDataFlieKey].dataSource,e=this.layerDataDict[d.layerDataFlieKey].dataIndex;var u=d.controlData.canvas["Canvas scale"].width.value;let l=d.controlData.canvas["Canvas scale"].x.value,o=2*(this.outerRadius+l)*Math.PI/this.root.leaves().length*(1-d.controlData.motif["Motif style"].padding.value)*this.treeAngleRange/360,r=[],a=this.root.leaves().filter(t=>{var a=e.has(t.data.name);return a&&r.push(e.get(t.data.name).length),a});var[h,g]=d3.extent(r);let n=d3.scaleLinear().domain(h<0?[h,g]:[0,g]).range([0,u]),s=this.polarGroup.append("g"),i=d3.scaleOrdinal().domain(d.categoryList).range(d.categoryColorList);d.controlData.motif["Custom color"].switch.value&&(m=d.categoryList.map(t=>d.controlData.motif["Custom color"][t].value),console.log(m),i.range(m)),d.colorScale=i;var m=d.controlData.motif["Motif style"].type;let c="Motif Sites"==m.optionList[m.value]?"contributing_sites":"contributing_sites_and_scanned_sites";this.addAxis(d.controlData,s,n),a.forEach(a=>{let r=s.append("g").attr("transform",t=>`rotate(${a.x+this.treeStartAngle}) translate(${this.outerRadius+l},0)`);r.append("line").attr("class",d.controlData.motif["Line style"].id).attr("x2",t=>n(e.get(a.data.name).length)).call(t=>{this.renderAttr(t,d.controlData.motif["Line style"])}),t.columns.slice(2).forEach(l=>{var t=e.get(a.data.name)[l];if(null!=t){let e=JSON.parse(t);console.log(e),r.selectAll("motif_item").data(e[c]).join("g").call(t=>{t.append("rect").attr("class",d.controlData.motif["Motif style"].id).attr("x",t=>n(t.start)).attr("y",-o/2).attr("width",t=>n(t.end)-n(t.start)).attr("height",o).attr("fill",i(l)).call(t=>{this.renderAttr(t,d.controlData.motif["Motif style"])}).on("mouseenter",function(t){var[a]=d3.select(this).data();p.layerPlaneData.layerInformationHoverBoxClientX=t.clientX+20,p.layerPlaneData.layerInformationHoverBoxClientY=t.clientY,p.layerPlaneData.layerInformationHoverBoxTitle="Motif information",p.layerPlaneData.layerInformationHoverBoxDataArr=[{key:"ID",value:l},{key:"Motif",value:e.motif_meta.name},{key:"p-value",value:a.pvalue},{key:"Start",value:a.start},{key:"End",value:a.end}],p.layerPlaneData.isShowLayerInformationHoverBox=!0}).on("mouseleave",t=>{p.layerPlaneData.isShowLayerInformationHoverBox=!1}),d.controlData.motif["Motif text"].switch.value&&t.append("g").attr("transform",t=>a.absoluteStartAngle<180?`translate(${(n(t.end)+n(t.start))/2},0)`:`translate(${(n(t.end)+n(t.start))/2},0) rotate(180)`).append("text").text(l.split("_")[1]).attr("class",d.controlData.motif["Motif text"].id).attr("dy","0.35em").attr("text-anchor","middle").call(t=>{this.renderAttr(t,d.controlData.motif["Motif text"])})})}})})}})}drawBaseBarPlot(){let t=this.layerPlaneData.layerStatistic["base bar plot"]||[];console.log("bar"),console.log(t),t.forEach((d,t)=>{if(d.isShowObj.isShow){var u=this.layerDataDict[d.layerDataFlieKey].dataSource;let l=this.layerDataDict[d.layerDataFlieKey].dataIndex,r=u.columns[d.layerDataColumnsIndex[0]];var h=d.controlData.canvas["Canvas scale"].width.value;let a=d.controlData.canvas["Canvas scale"].x.value,e=2*(this.outerRadius+a)*Math.PI/this.root.leaves().length*(1-d.controlData.bar["Bar style"].padding.value)*this.treeAngleRange/360,o=[],t=this.root.leaves().filter(t=>{var a=l.has(t.data.name)&&l.get(t.data.name)[r];return a&&o.push(l.get(t.data.name)[r]),a});var[g,u]=d3.extent(o);let n=d3.scaleLinear().domain(g<0?[g,u]:[0,u]).range([0,h]),s=this.polarGroup.append("g"),i=t.map(t=>{return{barStart:t.x-e/2,barWidth:e,barHeight:n(l.get(t.data.name)[r]),fill:d.controlData.bar["Bar style"].fill.value,text:l.get(t.data.name)[r],textY:n(l.get(t.data.name)[r])+10,textX:e/2}});i.barStyle=d.controlData.bar["Bar style"],i.textStyle=d.controlData.bar["Bar text"],i.initType=null,this.addAxis(d.controlData,s,n);let c=s.selectAll("newBar").data(t).join("g").attr("transform",t=>`rotate(${t.x+this.treeStartAngle}) translate(${this.outerRadius+a},0)`);if(c.append("rect").attr("width",t=>Math.abs(n(l.get(t.data.name)[r])-n(0))).attr("height",e).attr("y",-e/2).attr("x",t=>l.get(t.data.name)[r]<0?n(l.get(t.data.name)[r]):n(0)).attr("class",d.controlData.bar["Bar style"].id).call(t=>{this.renderAttr(t,d.controlData.bar["Bar style"])}),d.controlData.bar["Bar text"].switch.value){let e=d.controlData.bar["Bar text"];c.append("g").attr("transform",t=>e.align&&e.align.value?`${t.absoluteStartAngle<180?"rotate(0)":"rotate(180)"}`:t.absoluteStartAngle<180?`translate(${n(l.get(t.data.name)[r])},0)`:`translate(${n(l.get(t.data.name)[r])},0) rotate(180)`).append("text").text(t=>{let a=l.get(t.data.name)[r];return e["value-format"]&&e["value-format"].value&&(a=d3.format(e["value-format"].value)(a)),a}).attr("text-anchor",t=>0<l.get(t.data.name)[r]?t.absoluteStartAngle<180?"start":"end":180<t.absoluteStartAngle?"start":"end").attr("x",t=>0<l.get(t.data.name)[r]?t.absoluteStartAngle<180?e.x.value:-e.x.value:180<t.absoluteStartAngle?e.x.value:-e.x.value).attr("class",e.id).attr("dy","0.35em").call(t=>{this.renderAttr(t,e)})}}})}drawBaseLollipopPlot(){let t=this.layerPlaneData.layerStatistic["base lollipop plot"]||[];console.log("bar"),console.log(t),t.forEach((d,t)=>{if(d.isShowObj.isShow){var u=this.layerDataDict[d.layerDataFlieKey].dataSource;let l=this.layerDataDict[d.layerDataFlieKey].dataIndex,r=u.columns[d.layerDataColumnsIndex[0]];var h=d.controlData.canvas["Canvas scale"].width.value;let a=d.controlData.canvas["Canvas scale"].x.value,e=[];u=this.root.leaves().filter(t=>{var a=l.has(t.data.name)&&l.get(t.data.name)[r];return a&&e.push(l.get(t.data.name)[r]),a});let[t,o]=d3.extent(e),n=d3.scaleLinear().domain(t<0?[t,o]:[0,o]).range([0,h]),s=this.polarGroup.append("g");this.addAxis(d.controlData,s,n);let i=d3.scaleLinear().domain([t,o].map(t=>t<0?0:t)).range([d.controlData.lollipop["Lollipop size"]["min-radius"].value,d.controlData.lollipop["Lollipop size"]["max-radius"].value]),c=s.selectAll("newBar").data(u).join("g").attr("transform",t=>`rotate(${t.x+this.treeStartAngle}) translate(${this.outerRadius+a},0)`);if(c.append("line").attr("x2",t=>n(l.get(t.data.name)[r])).attr("x1",t=>n(0)).attr("class",d.controlData.lollipop["Line style"].id).call(t=>{this.renderAttr(t,d.controlData.lollipop["Line style"])}),c.append("circle").attr("class",d.controlData.lollipop["Lollipop style"].id).attr("cx",t=>n(l.get(t.data.name)[r])).call(t=>{this.renderAttr(t,d.controlData.lollipop["Lollipop style"]),d.controlData.lollipop["Lollipop size"].switch.value?(d.controlData.lollipop["Lollipop style"].r.isSvgAttr=!1,t.attr("r",t=>i(Math.abs(l.get(t.data.name)[r])))):d.controlData.lollipop["Lollipop style"].r.isSvgAttr=!0}),d.controlData.lollipop["Lollipop text"].switch.value){let e=d.controlData.lollipop["Lollipop text"];c.append("g").attr("transform",t=>e.align&&e.align.value?`${t.absoluteStartAngle<180?"rotate(0)":"rotate(180)"}`:t.absoluteStartAngle<180?`translate(${n(l.get(t.data.name)[r])},0)`:`translate(${n(l.get(t.data.name)[r])},0) rotate(180)`).append("text").text(t=>{let a=l.get(t.data.name)[r];return e["value-format"]&&e["value-format"].value&&(a=d3.format(e["value-format"].value)(a)),a}).attr("text-anchor","middle").attr("x",t=>0<l.get(t.data.name)[r]?t.absoluteStartAngle<180?e.x.value:-e.x.value:180<t.absoluteStartAngle?e.x.value:-e.x.value).attr("class",e.id).attr("dy","0.35em").call(t=>{this.renderAttr(t,e)})}}})}drawBaseLollipopPlotCategory(){let t=this.layerPlaneData.layerStatistic["lollipop plot with category"]||[];console.log("bar"),console.log(t),t.forEach((h,t)=>{if(h.isShowObj.isShow){var g=this.layerDataDict[h.layerDataFlieKey].dataSource;let l=this.layerDataDict[h.layerDataFlieKey].dataIndex,r=g.columns[h.layerDataColumnsIndex[1]],a=g.columns[h.layerDataColumnsIndex[0]];var m=h.controlData.canvas["Canvas scale"].width.value;let e=h.controlData.canvas["Canvas scale"].x.value,o=[];g=this.root.leaves().filter(t=>{var a=l.has(t.data.name)&&l.get(t.data.name)[r];return a&&o.push(l.get(t.data.name)[r]),a});let[t,n]=d3.extent(o),s=d3.scaleLinear().domain(t<0?[t,n]:[0,n]).range([0,m]),i=this.polarGroup.append("g");this.addAxis(h.controlData,i,s);let c=d3.scaleLinear().domain([t,n].map(t=>t<0?0:t)).range([h.controlData.lollipop["Lollipop size"]["min-radius"].value,h.controlData.lollipop["Lollipop size"]["max-radius"].value]),d=d3.scaleOrdinal().domain(h.categoryList).range(h.categoryColorList);h.controlData.lollipop["Lollipop color"].switch.value&&(m=h.categoryList.map(t=>h.controlData.lollipop["Lollipop color"][t].value),console.log(m),d.range(m)),h.colorScale=d;let u=i.selectAll("newBar").data(g).join("g").attr("transform",t=>`rotate(${t.x+this.treeStartAngle}) translate(${this.outerRadius+e},0)`);if(u.append("line").attr("x2",t=>s(l.get(t.data.name)[r])).attr("x1",t=>s(0)).attr("class",h.controlData.lollipop["Line style"].id).call(t=>{this.renderAttr(t,h.controlData.lollipop["Line style"])}),u.append("circle").attr("class",h.controlData.lollipop["Lollipop style"].id).attr("cx",t=>s(l.get(t.data.name)[r])).attr("fill",t=>d(l.get(t.data.name)[a])).call(t=>{this.renderAttr(t,h.controlData.lollipop["Lollipop style"]),h.controlData.lollipop["Lollipop size"].switch.value?(h.controlData.lollipop["Lollipop style"].r.isSvgAttr=!1,t.attr("r",t=>c(Math.abs(l.get(t.data.name)[r])))):h.controlData.lollipop["Lollipop style"].r.isSvgAttr=!0}),h.controlData.lollipop["Lollipop text"].switch.value){let e=h.controlData.lollipop["Lollipop text"];u.append("g").attr("transform",t=>e.align&&e.align.value?`${t.absoluteStartAngle<180?"rotate(0)":"rotate(180)"}`:t.absoluteStartAngle<180?`translate(${s(l.get(t.data.name)[r])},0)`:`translate(${s(l.get(t.data.name)[r])},0) rotate(180)`).append("text").text(t=>{let a=l.get(t.data.name)[r];return e["value-format"]&&e["value-format"].value&&(a=d3.format(e["value-format"].value)(a)),a}).attr("text-anchor","middle").attr("x",t=>0<l.get(t.data.name)[r]?t.absoluteStartAngle<180?e.x.value:-e.x.value:180<t.absoluteStartAngle?e.x.value:-e.x.value).attr("class",e.id).attr("dy","0.35em").call(t=>{this.renderAttr(t,e)})}}})}drawStackedBarPlot(){let t=this.layerPlaneData.layerStatistic["stacked bar plot"]||[];console.log(t);this.innerHeight,this.root.leaves().length;t.forEach((c,t)=>{if(c.isShowObj.isShow){var d=this.layerDataDict[c.layerDataFlieKey].dataSource;let r=this.layerDataDict[c.layerDataFlieKey].dataIndex,o=d.columns,t=[];this.root.leaves().forEach(l=>{if(r.has(l.data.name)){let a={x:l.x},e=0;c.layerDataColumnsIndex.forEach(t=>{null==r.get(l.data.name)[o[t]]&&e++,a[o[t]]=r.get(l.data.name)[o[t]]||0}),e!=c.layerDataColumnsIndex.length&&t.push(a)}}),t.columns=c.layerDataColumnsIndex.map(t=>o[t]);let a=d3.stack().keys(t.columns).offset(d3.stackOffsetNone)(t);console.log(t),console.log(a);d=c.controlData.canvas["Canvas scale"].width.value;let e=c.controlData.canvas["Canvas scale"].x.value,l=d3.scaleLinear().domain([0,d3.max(a,t=>d3.max(t,t=>t[1]))]).range([0,d]),n=d3.scaleOrdinal().domain(a.map(t=>t.key)).range(0==c.categoryColorList.length?["#8dd3c7","#ffffb3","#bebada","#fb8072","#80b1d3","#fdb462","#b3de69","#fccde5","#d9d9d9","#bc80bd","#ccebc5","#ffed6f"]:c.categoryColorList);c.isUseColorGradient&&n.range(d3.quantize(d3[c.colorInterpolate],n.domain().length)),c.controlData.bar["Custom color"].switch.value&&(d=a.map(t=>c.controlData.bar["Custom color"][t.key].value),n.range(d)),c.colorScale=n,console.log("9kk",c.categoryColorList);let s=2*(this.outerRadius+e)*Math.PI/this.root.leaves().length*(1-c.controlData.bar["Bar style"].padding.value)*this.treeAngleRange/360,i=this.polarGroup.append("g");this.addAxis(c.controlData,i,l),i.selectAll(".barG").data(a).join("g").attr("class",c.controlData.bar["Bar style"].id).attr("fill",t=>n(t.key)).call(t=>{this.renderAttr(t,c.controlData.bar["Bar style"]),t.append("title").text(t=>t.key),t.selectAll("rect").data(t=>t).join("g").attr("transform",t=>`rotate(${t.data.x+this.treeStartAngle}) translate(${this.outerRadius+e},0)`).append("rect").attr("y",t=>-s/2).attr("width",t=>l(t[1])-l(t[0])).attr("height",s).attr("x",t=>l(t[0]))})}})}drawBoxPlot(){const u=this;let t=u.layerPlaneData.layerStatistic["base box plot"]||[];console.log(t),t.forEach((n,t)=>{if(n.isShowObj.isShow){var l=this.layerDataDict[n.layerDataFlieKey].dataSource;let r=this.layerDataDict[n.layerDataFlieKey].dataIndex,o=l.columns,s=[];this.root.leaves().forEach(l=>{if(r.has(l.data.name)){let a={leafName:l.data.name},e=0;n.layerDataColumnsIndex.forEach(t=>{null==r.get(l.data.name)[o[t]]&&e++,a[o[t]]=r.get(l.data.name)[o[t]]}),e!=n.layerDataColumnsIndex.length&&s.push(a)}}),s.columns=n.layerDataColumnsIndex.map(t=>o[t]),console.log(s);var i=u.getMaxMinValue(s,s.columns),c=n.controlData.canvas["Canvas scale"].width.value,d=d3.scaleLinear().domain([i[0]<0?1.1*i[0]:.9*i[0],i[1]]).range([0,c]),l=d3.scaleOrdinal().range([n.controlData.box["Box style"].fill.value]);let t=s.map(a=>{let e=s.columns.map(t=>a[t]).filter(t=>null!=t);var[t,l,r,o,n]=[0,.25,.5,.75,1].map(t=>d3.quantile(e,t));return{name:a.leafName,min:t,q1:l,m:r,q3:o,max:n,sd:null,dataArr:e}});i=n.controlData.canvas["Canvas scale"].x.value;let a=2*(this.outerRadius+i)*Math.PI/this.root.leaves().length*(1-n.controlData.box["Box style"].padding.value)*this.treeAngleRange/360,e={};this.root.leaves().forEach(t=>{e[t.data.name]=t.x+this.treeStartAngle});c=function(t){return e[t]};c.bandwidth=()=>a,t.innerxScale=c,t.xScale=d,t.colorScale=l,t.boxStyle=n.controlData.box["Box style"],t.pointStyle=n.controlData.point["Point style"],t.significanceStyle=n.controlData.significance,t.translateX=this.outerRadius+i,console.log("9kk",n.categoryColorList);i=this.polarGroup.append("g");this.addAxis(n.controlData,i,d),u.barPlot.drawCircleBox(i,t)}})}drawBoxPlotCategory(){const g=this;let t=g.layerPlaneData.layerStatistic["box plot with category"]||[];console.log(t),t.forEach((o,t)=>{if(o.isShowObj.isShow){var n=this.layerDataDict[o.layerDataFlieKey].dataSource;let s=this.layerDataDict[o.layerDataFlieKey].dataIndex,r=n.columns,i=n.columns[o.layerDataColumnsIndex[0]],c=[],t=o.layerDataColumnsIndex.slice(1);this.root.leaves().forEach(l=>{if(s.has(l.data.name)){let a={leafName:l.data.name},e=0;t.forEach(t=>{null==s.get(l.data.name)[r[t]]&&e++,a[r[t]]=s.get(l.data.name)[r[t]]}),e!=t.length&&c.push(a)}}),c.columns=t.map(t=>r[t]),console.log(c);var d=g.getMaxMinValue(c,c.columns),u=o.controlData.canvas["Canvas scale"].width.value,h=d3.scaleLinear().domain([d[0]<0?1.1*d[0]:.9*d[0],d[1]]).range([0,u]),n=d3.scaleOrdinal().domain(o.categoryList).range(o.categoryColorList);o.colorScale=n;let a=c.map(a=>{let e=c.columns.map(t=>a[t]).filter(t=>null!=t);var[t,l,r,o,n]=[0,.25,.5,.75,1].map(t=>d3.quantile(e,t));return{name:a.leafName,colorScaleKey:s.get(a.leafName)[i],min:t,q1:l,m:r,q3:o,max:n,sd:null,dataArr:e}});d=o.controlData.canvas["Canvas scale"].x.value;let e=2*(this.outerRadius+d)*Math.PI/this.root.leaves().length*(1-o.controlData.box["Box style"].padding.value)*this.treeAngleRange/360,l={};this.root.leaves().forEach(t=>{l[t.data.name]=t.x+this.treeStartAngle});u=function(t){return l[t]};u.bandwidth=()=>e,a.innerxScale=u,a.xScale=h,a.colorScale=n,a.boxStyle=o.controlData.box["Box style"],a.pointStyle=o.controlData.point["Point style"],a.significanceStyle=o.controlData.significance,a.translateX=this.outerRadius+d,console.log("9kk",o.categoryColorList);d=this.polarGroup.append("g");this.addAxis(o.controlData,d,h),g.barPlot.drawCircleBox(d,a)}})}drawLinks(){let t=this.layerPlaneData.layerStatistic["link between two nodes"]||[],e=this.figureData.leaves["Leaves Extension"].extension.value,c={};this.root.leaves().forEach(t=>{var a=e?this.outerRadius:t.radius;c[t.data.name]={x:(t.x+this.absoluteStartAngle)*Math.PI/180,y:a}}),console.log(c),t.forEach((s,t)=>{if(s.isShowObj.isShow){let r=this.layerDataDict[s.layerDataFlieKey].dataSource,o=d3.lineRadial().curve(d3.curveBundle.beta(.85)).radius(t=>t.y+s.controlData.link["Link style"].offset.value).angle(t=>t.x);console.log("9jjj",r),console.log(this.root.leaves());let n=s.controlData.link["Link color"]["color-type"];var a,i=r.filter(t=>{var a=c[t.source]&&c[t.target];return a||console.log("no such link id:",t.id),a}).map(t=>{var a=s.controlData.link["Link style"]["link-type"],e={x:c[t.source].x,y:c[t.source].y},l={x:0,y:0},t={x:c[t.target].x,y:c[t.target].y};if("pure"==n.optionList[n.value]||s.controlData.link["Color categories"]&&s.controlData.link["Color categories"].switch.value)return"elliptical"==a.optionList[a.value]?o([e,l,t]):o([e,t]);let r="elliptical"==a.optionList[a.value]?splitPath(o,[e,l,t]):splitPath(o,[e,t]);return Array.from(r.split(8))});if(console.log("pathData",i),"pure"==n.optionList[n.value]||s.controlData.link["Color categories"]&&s.controlData.link["Color categories"].switch.value){let l=d3.scaleOrdinal().domain(s.categoryList);return s.controlData.link["Color categories"]&&s.controlData.link["Color categories"].switch.value&&(a=s.categoryList.map(t=>s.controlData.link["Color categories"][t].value),console.log(a),l.range(a)),s.colorScale=l,void this.polarGroup.append("g").selectAll("nodelink").data(i).join("path").attr("d",t=>t).attr("fill","none").attr("stroke",(t,a)=>{if(s.controlData.link["Color categories"]&&s.controlData.link["Color categories"].switch.value){var e=r.columns[s.layerDataColumnsIndex[2]];return l(r[a][e])}return s.controlData.link["Link color"].pure.value}).call(t=>{this.renderAttr(t,s.controlData.link["Link style"])})}i=d3.transpose(i);d3.interpolateRgbBasis(["#ffffff","#ff6668"]);let e=d3.interpolateRgbBasis([s.controlData.link["Link color"].source.value,s.controlData.link["Link color"].target.value]);this.polarGroup.append("g").selectAll("nodelink").data(i).join("path").attr("d",t=>t.join("")).attr("fill","none").attr("stroke",(t,a)=>e(d3.easeQuad(a/255))).call(t=>{this.renderAttr(t,s.controlData.link["Link style"])})}})}drawHeatmap(){const v=this;let t=v.layerPlaneData.layerStatistic.heatmap||[];console.log("heatmap"),console.log(t);let f=this.treeAngleRange/this.root.leaves().length;t.forEach((u,t)=>{if(u.isShowObj.isShow){var h=this.layerDataDict[u.layerDataFlieKey].dataSource;let r=this.layerDataDict[u.layerDataFlieKey].dataIndex,l=h.columns,t=this.root.leaves().filter(t=>r.has(t.data.name)),e=t.map(a=>{let e={};return u.layerDataColumnsIndex.forEach(t=>{e[l[t]]=r.get(a.data.name)[l[t]]}),e});e.columns=u.layerDataColumnsIndex.map(t=>l[t]),console.log(e);var g=u.controlData.cell["Cell style"]["zero-style"];let o=g.optionList[g.value];var m=u.controlData.canvas["Canvas scale"].width.value;let a=d3.scaleBand().domain(e.columns).range([0,m]),n=a.bandwidth(),s=this.polarGroup.append("g").attr("class","heatmapG");this.addAxis(u.controlData,s,a);let i=v.getMaxMinValue(e,e.columns);var p=u.controlData.legend["ColorBar range"]["max-value"].value;""!=p&&Number(p)>i[1]&&(i[1]=Number(p));h=u.controlData.legend["ColorBar range"]["min-value"].value;""!=h&&Number(h)<i[0]&&(i[0]=Number(h)),u.mmv=i,u.customColorInterpolate=d3[u.colorInterpolate||"interpolateRdBu"],u.controlData.cell["Color bar"]["custom-color"].value&&(g=u.controlData.cell["Color bar"]["gradient-type"],m=u.controlData.cell["Color bar"].start.value,p=u.controlData.cell["Color bar"].middle.value,h=u.controlData.cell["Color bar"].end.value,"start-end"==g.optionList[g.value]?u.customColorInterpolate=d3.scaleLinear().domain([0,1]).range([m,h]):u.customColorInterpolate=d3.scaleLinear().domain([0,.5,1]).range([m,p,h]));let c=d3.scaleSequential(u.controlData.legend["ColorBar range"].reverse.value?[u.mmv[1],u.mmv[0]]:u.mmv,u.customColorInterpolate);if(u.controlData.legend["ColorBar range"]["median-value"].value){let e=Number(u.controlData.legend["ColorBar range"]["median-value"].value);c=t=>{let a=d3.scaleLinear().domain(u.controlData.legend["ColorBar range"].reverse.value?[i[1],e,i[0]]:[i[0],e,i[1]]).range([0,.5,1]);return u.customColorInterpolate(a(t))}}let d=u.controlData.canvas["Canvas scale"].x.value;s.selectAll(".row").data(this.root.leaves().filter(t=>r.has(t.data.name))).join("g").each(function(t,a){let l=d3.select(this);e.columns.forEach((a,e)=>{null!=r.get(t.data.name)[a]&&(l.append("path").attr("d",t=>{let a=d3.arc().innerRadius(e*n+v.maxLength+d).outerRadius((e+1)*n+v.maxLength+d).startAngle((t.x-f/2+v.absoluteStartAngle)*Math.PI/180).endAngle((t.x+f/2+v.absoluteStartAngle)*Math.PI/180);return a()}).attr("fill",t=>{t=r.get(t.data.name)[a];return 0==t&&"normal"!=o?"none":c(t)}).call(t=>{v.renderAttr(t,u.controlData.cell["Cell style"])}).attr("stroke-width",t=>{return 0==r.get(t.data.name)[a]&&"blank"==o?0:u.controlData.cell["Cell style"]["stroke-width"].value}),u.controlData.cell["Cell text"].switch.value&&l.filter(t=>!!u.controlData.cell["Cell text"]["zero-text"].value||0!=r.get(t.data.name)[a]).append("text").attr("transform",t=>`rotate(${t.x+v.treeStartAngle}) translate(${(e+.5)*n+v.maxLength+d},0)${t.absoluteStartAngle<180?"":" rotate(180)"}`).text(t=>r.get(t.data.name)[a]).attr("dy","0.35em").attr("text-anchor","middle").call(t=>{v.renderAttr(t,u.controlData.cell["Cell text"])}).attr("fill",t=>{return.5<d3.hsl(c(r.get(t.data.name)[a])).l?"#222":"#fff"}))})})}})}drawBinary2(){const d=this;let t=d.layerPlaneData.layerStatistic["binary type 2"]||[],u=this.treeAngleRange/this.root.leaves().length;t.forEach((i,t)=>{if(i.isShowObj.isShow){var c=this.layerDataDict[i.layerDataFlieKey].dataSource;let l=this.layerDataDict[i.layerDataFlieKey].dataIndex,r=c.columns,t=this.root.leaves().filter(t=>l.has(t.data.name)),e=t.map(a=>{let e={};return i.layerDataColumnsIndex.forEach(t=>{e[r[t]]=l.get(a.data.name)[r[t]]}),e});e.columns=i.layerDataColumnsIndex.map(t=>r[t]),console.log(e);c=i.controlData.canvas["Canvas scale"].width.value;let a=d3.scaleBand().domain(e.columns).range([0,c]),o=a.bandwidth(),n=this.polarGroup.append("g").attr("class","heatmapG");this.addAxis(i.controlData,n,a);let s=i.controlData.canvas["Canvas scale"].x.value;n.selectAll(".row").data(t).join("g").call((t,a)=>{e.columns.forEach((a,e)=>{t.filter(t=>null!=l.get(t.data.name)[a]).append("path").attr("d",t=>{let a=d3.arc().innerRadius(e*o+this.maxLength+s).outerRadius((e+1)*o+this.maxLength+s).startAngle((t.x-u/2+d.absoluteStartAngle)*Math.PI/180).endAngle((t.x+u/2+d.absoluteStartAngle)*Math.PI/180);return a()}).attr("class",i.controlData.cell["Cell style"].id).attr("fill-opacity",t=>i.controlData.cell["Custom color"].switch.value?(i.controlData.cell["Cell style"].fill.isSvgAttr=!1,1):0==l.get(t.data.name)[a]?.4:1).attr("fill",t=>(i.controlData.cell["Custom color"].switch.value?0==l.get(t.data.name)[a]?i.controlData.cell["Custom color"].absent:i.controlData.cell["Custom color"].present:i.controlData.cell["Cell style"].fill).value).call(t=>{this.renderAttr(t,i.controlData.cell["Cell style"])}),i.controlData.cell["Cell text"].switch.value&&t.append("text").attr("transform",t=>`rotate(${t.x+this.treeStartAngle}) translate(${(e+.5)*o+this.maxLength+s},0)${t.absoluteStartAngle<180?"":" rotate(180)"}`).text(t=>l.get(t.data.name)[a]).attr("dy","0.35em").attr("class",i.controlData.cell["Cell text"].id).attr("text-anchor","middle").call(t=>{this.renderAttr(t,i.controlData.cell["Cell text"])}).attr("fill",t=>{return.5<d3.hsl(i.controlData.cell["Cell style"].fill.value).l?"#222":"#fff"})})})}})}drawBinary(){let t=this.layerPlaneData.layerStatistic["binary type 1"]||[];console.log(t),t.forEach((c,t)=>{if(c.isShowObj.isShow){let l=this.layerDataDict[c.layerDataFlieKey].dataIndex,t=this.root.leaves().filter(t=>l.has(t.data.name)),e=t.map(a=>{let e={};return c.categoryList.forEach(t=>{e[t]=l.get(a.data.name)[t]}),e});e.columns=c.categoryList,console.log(e);var d=c.controlData.canvas["Canvas scale"].width.value;let a=d3.scaleBand().domain(e.columns).range([0,d]),r=c.controlData.canvas["Canvas scale"].x.value,o=a.bandwidth();var u=2*(r+this.outerRadius)*Math.PI/this.root.leaves().length*this.treeAngleRange/360;let n=this.polarGroup.append("g");this.addAxis(c.controlData,n,a);let s=d3.scaleOrdinal().domain(e.columns).range(0==c.categoryColorList.length?["#cccccc"]:c.categoryColorList);c.controlData.cell["Custom color"].switch.value&&s.range(c.categoryList.map(t=>c.controlData.cell["Custom color"][t].value)),c.controlData.cell["Pure color"].switch.value&&s.range([c.controlData.cell["Pure color"].color.value]);d=Math.min(o,u)/2*c.controlData.cell["Cell style"]["size-rate"].value,u=c.controlData.cell["Cell style"]["symbol-type"],u=u.optionList[u.value];let i=this.symbolGenerator.getPath(u,d);n.selectAll(".row").data(t).join("g").attr("transform",t=>`rotate(${t.x+this.treeStartAngle}) translate(${this.outerRadius+r},0)`).call((t,a)=>{e.columns.forEach((a,e)=>{t.filter(t=>null!=l.get(t.data.name)[a]).append("g").attr("transform",(t,a)=>`translate(${(e+.5)*o},0)`).append("path").attr("d",i).attr("fill",t=>{return 0==l.get(t.data.name)[a]?"none":s(a)}).attr("stroke",t=>s(a)).attr("class",c.controlData.cell["Cell style"].id).call(t=>{this.renderAttr(t,c.controlData.cell["Cell style"])}).append("title").text(t=>l.get(t.data.name)[a])})})}})}drawBubblePlot(){const m=this;let t=m.layerPlaneData.layerStatistic["bubble plot"]||[];console.log(t),t.forEach((d,t)=>{if(d.isShowObj.isShow){let l=this.layerDataDict[d.layerDataFlieKey].dataIndex,t=this.root.leaves().filter(t=>l.has(t.data.name)),e=t.map(a=>{let e={};return d.categoryList.forEach(t=>{e[t]=l.get(a.data.name)[t]}),e});e.columns=d.categoryList,console.log(e);var u=m.getMaxMinValue(e.filter(t=>null!=t),e.columns);d.mmv=u;var h=d.controlData.canvas["Canvas scale"].width.value;let a=d3.scaleBand().domain(e.columns).range([0,h]),r=d.controlData.canvas["Canvas scale"].x.value,o=a.bandwidth();var g=2*(r+this.outerRadius)*Math.PI/this.root.leaves().length*this.treeAngleRange/360;let n=this.polarGroup.append("g");this.addAxis(d.controlData,n,a);let s=d3.scaleOrdinal().domain(e.columns).range(0==d.categoryColorList.length?["#cccccc"]:d.categoryColorList);d.controlData.bubble["Custom color"].switch.value&&s.range(d.categoryList.map(t=>d.controlData.bubble["Custom color"][t].value)),d.controlData.bubble["Pure color"].switch.value&&s.range([d.controlData.bubble["Pure color"].fill.value]);h=Math.min(o,g)/2,g=d.controlData.bubble["Bubble size"]["max-radius"].value;let i=d3.scaleLinear().domain([0,u[0],u[1]]).range([0,d.controlData.bubble["Bubble size"]["min-radius"].value,h<g?g:h]);d.rScale=i;h=d.controlData.bubble["Bubble style"]["symbol-type"];let c=h.optionList[h.value];d.symbolType=c,n.selectAll(".row").data(t).join("g").attr("transform",t=>`rotate(${t.x+this.treeStartAngle}) translate(${this.outerRadius+r},0)`).call((t,a)=>{e.columns.forEach((a,e)=>{t.filter(t=>null!=l.get(t.data.name)[a]).append("g").attr("transform",(t,a)=>`translate(${(e+.5)*o},0)`).append("path").attr("d",t=>this.symbolGenerator.getPath(c,i(l.get(t.data.name)[a]))).attr("fill",t=>s(a)).attr("class",d.controlData.bubble["Bubble style"].id).call(t=>{this.renderAttr(t,d.controlData.bubble["Bubble style"])}).append("title").text(t=>l.get(t.data.name)[a])})})}})}drawTextLabel(){let t=this.layerPlaneData.layerStatistic["text map"]||[];console.log(t),t.forEach((d,t)=>{if(d.isShowObj.isShow){let l=this.layerDataDict[d.layerDataFlieKey].dataIndex,a=this.layerDataDict[d.layerDataFlieKey].dataSource,t=this.root.leaves().filter(t=>l.has(t.data.name)),r=d.layerDataColumnsIndex.map(t=>a.columns[t]),e=t.map(a=>{let e={};return r.forEach(t=>{e[t]=l.get(a.data.name)[t]}),e});e.columns=r,console.log(e);var u=d.controlData.canvas["Canvas scale"].width.value;let o=d3.scaleBand().domain(e.columns).range([0,u]),n=d.controlData.canvas["Canvas scale"].x.value,s=o.bandwidth();n,this.outerRadius,Math.PI,this.root.leaves().length;let i=this.polarGroup.append("g");this.addAxis(d.controlData,i,o);let c=d3.scaleOrdinal().domain(e.columns).range(0==d.categoryColorList.length?["#cccccc"]:d.categoryColorList);d.controlData.text["Custom color"].switch.value&&c.range(d.categoryList.map(t=>d.controlData.text["Custom color"][t].value)),i.selectAll(".row").data(t).join("g").attr("transform",t=>`rotate(${t.x+this.treeStartAngle}) translate(${this.outerRadius+n},0)`).call((t,a)=>{e.columns.forEach((a,e)=>{t.filter(t=>null!=l.get(t.data.name)[a]).append("g").attr("transform",t=>`translate(${(e+.5)*s},0)${t.absoluteStartAngle<180?"":" rotate(180)"}`).append("text").attr("dy","0.35em").attr("fill",t=>c(a)).attr("class",d.controlData.text["Text style"].id).call(t=>{this.renderAttr(t,d.controlData.text["Text style"])}).text(t=>l.get(t.data.name)[a])})})}})}drawTextLabelCategory(){let t=this.layerPlaneData.layerStatistic["text map with category"]||[];console.log(t),t.forEach((d,t)=>{if(d.isShowObj.isShow){let l=this.layerDataDict[d.layerDataFlieKey].dataIndex,a=this.layerDataDict[d.layerDataFlieKey].dataSource,t=this.root.leaves().filter(t=>l.has(t.data.name)),r=d.layerDataColumnsIndex.map(t=>a.columns[t]),e=t.map(a=>{let e={};return r.forEach(t=>{e[t]=l.get(a.data.name)[t]}),e});e.columns=r.slice(1),console.log(e);var u=d.controlData.canvas["Canvas scale"].width.value;let o=d3.scaleBand().domain(e.columns).range([0,u]),n=d.controlData.canvas["Canvas scale"].x.value,s=o.bandwidth();n,this.outerRadius,Math.PI,this.root.leaves().length;let i=this.polarGroup.append("g");this.addAxis(d.controlData,i,o);let c=d3.scaleOrdinal().domain(d.categoryList).range(0==d.categoryColorList.length?["#cccccc"]:d.categoryColorList);d.controlData.text["Custom color"].switch.value&&c.range(d.categoryList.map(t=>d.controlData.text["Custom color"][t].value)),d.colorScale=c,i.selectAll(".row").data(t).join("g").attr("transform",t=>`rotate(${t.x+this.treeStartAngle}) translate(${this.outerRadius+n},0)`).call((t,a)=>{e.columns.forEach((a,e)=>{t.filter(t=>null!=l.get(t.data.name)[a]).append("g").attr("transform",t=>`translate(${(e+.5)*s},0)${t.absoluteStartAngle<180?"":" rotate(180)"}`).append("text").attr("dy","0.35em").attr("fill",t=>c(l.get(t.data.name)[r[0]])).attr("class",d.controlData.text["Text style"].id).call(t=>{this.renderAttr(t,d.controlData.text["Text style"])}).text(t=>l.get(t.data.name)[a])})})}})}drawTextBlock(){const y=this;let t=y.layerPlaneData.layerStatistic["color block of leaves name"];t&&t.forEach((u,h)=>{var g=this.layerDataDict[u.layerDataFlieKey].dataSource;let m=this.layerDataDict[u.layerDataFlieKey].dataIndex,p=g.columns[u.layerDataColumnsIndex[0]],v=u.controlData.block.block.x.value+this.maxLength;console.log("this.maxLength",this.maxLength);let f=u.controlData.block.block.x.value+this.maxLength+u.controlData.block.block.width.value,D=d3.scaleOrdinal().domain(u.categoryList).range(u.categoryColorList);if(console.log(this.styleData.isUseColorGradient),u.isUseColorGradient&&D.range(d3.quantize(d3[u.colorInterpolate],D.domain().length)),u.controlData.color["Custom color"].switch.value&&D.range(u.categoryList.map(t=>u.controlData.color["Custom color"][t].value)),u.colorScale=D,console.log(u.categoryColorList),u.isShowObj.isShow){let l=[],r=void 0,o=1/0,n=null,s=this.root.leaves();g=u.controlData.block.block["width-type"];let i=g.optionList[g.value];function x(a,t){return t.every(t=>a.leaves().includes(t))?a:x(a.parent,t)}s.forEach((t,a)=>{let e=m.has(t.data.name)&&m.get(t.data.name)[p]||"";e!=r&&(l.push({name:e.toString(),start:a,end:0,node_arr:[]}),0<=l.length-2&&(l[l.length-2].end=a-1,l[l.length-2].LCA=x(n,l[l.length-2].node_arr),l[l.length-2].maxChidrenLength=d3.max(l[l.length-2].node_arr,t=>t.radius),o=t.depth,n=t)),l[l.length-1].node_arr.push(t),t.depth<o&&(o=t.depth,n=t),r=e,a==s.length-1&&(l[l.length-1].end=a,l[l.length-1].LCA=x(n,l[l.length-1].node_arr),l[l.length-1].maxChidrenLength=d3.max(l[l.length-1].node_arr,t=>t.radius))}),console.log("block_data",l),l=l.filter(t=>""!=t.name),this.polarGroup.append("defs").selectAll(".gradient").data(l).join("radialGradient").each(function(t,a){let e=d3.select(this);e.attr("id",t=>`cboln-${t.name.replaceAll("'","-").replaceAll(" ","-").trim()}-${h}`).attr("cx","0").attr("cy","0").attr("r",t=>"uniform start and end"==i?f:"from LCA to uniform end"==i||"from branch tip to uniform end"==i?y.maxLength+u.controlData.block.block["width-offset"].value:"from LCA to max length of children"==i?t.maxChidrenLength+u.controlData.block.block["width-offset"].value:void 0).attr("gradientUnits","userSpaceOnUse"),e.append("stop").attr("offset",t=>{let a=f,e=v;return"uniform start and end"!=i&&(e=t.LCA.radius-t.LCA.data.length*y.treeScale/2),"from LCA to uniform end"!=i&&"from branch tip to uniform end"!=i||(a=y.maxLength+u.controlData.block.block["width-offset"].value),"from LCA to max length of children"==i&&(a=t.maxChidrenLength+u.controlData.block.block["width-offset"].value),e/a}).attr("stop-color",t=>D(t.name)).attr("stop-opacity",u.controlData.color["Color gradient"].reverse.value?0:1),e.append("stop").attr("offset",1).attr("stop-color",t=>D(t.name)).attr("stop-opacity",u.controlData.color["Color gradient"].reverse.value?1:0)});let e=this.treeAngleRange*Math.PI/180/s.length,a=u.controlData.block.block.padding.value/v,t=d3.arc().innerRadius(t=>"uniform start and end"==i?v:t.LCA.radius-t.LCA.data.length*this.treeScale/2).outerRadius(t=>"uniform start and end"==i?f:"from LCA to uniform end"==i?this.maxLength+u.controlData.block.block["width-offset"].value:"from LCA to max length of children"==i?t.maxChidrenLength+u.controlData.block.block["width-offset"].value:void 0).startAngle(t=>t.start*e+a/2+this.absoluteStartAngle*Math.PI/180).endAngle(t=>(t.end+1)*e-a+this.absoluteStartAngle*Math.PI/180),c=this.polarGroup.append("g").lower();"uniform start and end"==i&&u.controlData.block["Tick text"].switch.value&&(console.log("Tick text"),c.append("g").attr("transform",`rotate(${this.treeStartAngle})translate(${f-u.controlData.block.block.width.value/2},${-u.controlData.block["Tick text"].offset.value})`).append("text").text(p).attr("text-anchor","end").attr("dy","0.35em").attr("class",u.controlData.block["Tick text"].id).attr("transform",`rotate(${u.controlData.block["Tick text"].rotate.value})`).call(t=>{this.renderAttr(t,u.controlData.block["Tick text"])}));let d=[];"from branch tip to uniform end"==i&&(t=d3.arc().innerRadius(t=>t.radius).outerRadius(t=>this.maxLength+u.controlData.block.block["width-offset"].value).startAngle(t=>t.start*e+a/2+this.absoluteStartAngle*Math.PI/180).endAngle(t=>(t.end+1)*e-a+this.absoluteStartAngle*Math.PI/180),s.forEach((t,a)=>{m.has(t.data.name)&&m.get(t.data.name)[p]&&d.push({name:m.get(t.data.name)[p].toString(),start:a,end:a,radius:t.radius})})),c.selectAll("taxblock_t").data("from branch tip to uniform end"==i?d:l).join("path").attr("class",`color-block-${h}`).attr("d",t).attr("fill-opacity",u.controlData.block.block["fill-opacity"].value).call(t=>{u.controlData.color["Color gradient"].switch.value?t.attr("fill",(t,a)=>`url('#cboln-${t.name.replaceAll("'","-").replaceAll(" ","-").trim()}-${h}')`):(t.attr("fill",t=>D(t.name)),"from branch tip to uniform end"==i&&t.clone().attr("fill","none").attr("stroke",t=>D(t.name))),"from branch tip to uniform end"!=i&&t.attr("stroke",t=>{let a=u.controlData.block.block.stroke.value;var e;return"stroke-type"in u.controlData.block.block&&("stroke as fill color"==(e=(e=u.controlData.block.block["stroke-type"]).optionList[e.value])&&(a=D(t.name)),"stroke as darker fill color"==e&&(a=d3.hsl(D(t.name)).darker(2))),a}).attr("stroke-width",u.controlData.block.block["stroke-width"].value)}),u.controlData.block.text.switch.value&&c.selectAll("taxblock_T").data(l).join("g").attr("transform",t=>{let a=f;"from LCA to uniform end"!=i&&"from branch tip to uniform end"!=i||(a=this.maxLength+u.controlData.block.block["width-offset"].value),"from LCA to max length of children"==i&&(a=t.maxChidrenLength+u.controlData.block.block["width-offset"].value);t=(t.start+t.end+1)/2*e/(Math.PI/180)+this.treeStartAngle;return u.controlData.block.text.horizontal.value?`rotate(${t}) translate(${u.controlData.block.text.x.value+a},0)`:`rotate(${t}) translate(${u.controlData.block.text.x.value+a},0) ${(t+90)%360<180?"":" rotate(180)"}`}).append("text").attr("class",u.controlData.block.text.id).attr("text-anchor",t=>{return 90==u.controlData.block.text.rotate.value?"middle":((t.start+t.end+1)/2*e/(Math.PI/180)+this.absoluteStartAngle)%360<180?"start":"end"}).attr("transform",t=>{t=(t.start+t.end+1)/2*e/(Math.PI/180);return u.controlData.block.text.horizontal.value?`rotate(${-(t+this.treeStartAngle)})`:`rotate(${((t+this.absoluteStartAngle)%360<180?1:-1)*u.controlData.block.text.rotate.value})`}).attr("fill",t=>u.controlData.block.text["fill-as-block"].value?D(t.name):u.controlData.block.text.fill.value).text(t=>t.name).attr("dy","0.35em").call(t=>{this.renderAttr(t,u.controlData.block.text)})}})}drawLengthAxis(){if(this.figureData["length axis"].Axis.switch.value){var a=this.outerRadius/this.treeScale,e=this.figureData["length axis"].Axis["position-type"],l=e.optionList[e.value],r=this.figureData["length axis"].Tick["scale-by-factor"].value,o=this.figureData["length axis"].Tick["offset-value"].value;let t=this.figureData["length axis"].Tick.reverseValues.value?[o+a,o]:[o,o+a];0!=r&&(t[0]*=r,t[1]*=r);e=d3.scaleLinear().domain(t).range([0,this.outerRadius]),o=this.figureData["length axis"].Axis.offset.value,a=this.polarGroup.append("g"),r={canvas:{"Canvas scale":{width:{value:this.outerRadius},x:{value:-this.outerRadius}}},xAxis:this.figureData["length axis"]};this.addAxis(r,a,e,"bottom"==l?"axisBottom":"axisTop",{vOffset:o})}}geologicTimeScale(){let t=this.layerPlaneData.layerStatistic["geologic time scale"]||[];t.forEach((d,t)=>{if(d.isShowObj.isShow){let t=this.layerDataDict[d.layerDataFlieKey].dataSource,[a,e,l]=t.columns.slice(1),r=d.controlData.period.Position.offset.value,o=this.outerRadius/this.treeScale;var u=this.figureData["length axis"].Tick["scale-by-factor"].value;0!=u&&(o*=u);let n=d3.scaleLinear().domain([o,0]).range([0,this.outerRadius]),s=d3.scaleOrdinal().domain(d.categoryList).range(d.categoryColorList);d.controlData.period["Custom color"].switch.value&&s.range(d.categoryList.map(t=>d.controlData.period["Custom color"][t].value));u=this.figureData["length axis"].Axis["position-type"];let i=u.optionList[u.value],c=this.polarGroup.append("g").attr("transform",t=>{var a="bottom"==i?"axisBottom":"axisTop";let e=this.treeStartAngle;return"axisBottom"==a&&(e+=this.treeAngleRange),`rotate(${e})translate(0,${"bottom"==i?r:-r})`}).selectAll("periodRect").data(t).join("g").attr("transform",t=>`translate(${n(t[e])},${"bottom"==i?0:-d.controlData.period["Period style"].height.value})`);c.append("rect").attr("class",d.controlData.period["Period style"].id).attr("width",t=>n(t[l])-n(t[e])).attr("height",d.controlData.period["Period style"].height.value).attr("fill",t=>s(t[a])).call(t=>{this.renderAttr(t,d.controlData.period["Period style"])}),c.append("text").attr("class",d.controlData.period["Text style"].id).text(t=>t[a]).attr("x",t=>(n(t[l])-n(t[e]))/2).attr("y",d.controlData.period["Period style"].height.value/2).attr("dy","0.35em").attr("text-anchor","middle").call(t=>{this.renderAttr(t,d.controlData.period["Text style"])})}})}addAxis(a,e,l,r="axisTop",{}={}){if(a.xAxis.Axis){if(!a.xAxis.Axis.switch.value)return;"position-type"in a.xAxis.Axis&&(c=a.xAxis.Axis["position-type"],r="bottom"==c.optionList[c.value]?"axisBottom":"axisTop",a.xAxis.Axis.offset.value)}let o=a.canvas["Canvas scale"].x.value,n=a.canvas["Canvas scale"].width.value;const s=a.xAxis.Tick;if(a.background&&a.background.Background.switch.value){let t=d3.arc().innerRadius(o+this.outerRadius).outerRadius(o+this.outerRadius+n).startAngle(this.absoluteStartAngle*Math.PI/180).endAngle(this.treeEndAngle*Math.PI/180);e.append("path").attr("d",t()).attr("class",a.background.Background.id).call(t=>{this.renderAttr(t,a.background.Background)})}const t=d3[r](l);s.hasOwnProperty("tickValues")&&s.tickValues.value?t.tickValues(s.tickValues.value.split(",")):"l"==l.name&&t.ticks(Math.floor(n/50));const i=e.append("g").attr("transform",t=>{let a=this.treeStartAngle;return"axisBottom"==r&&(a+=this.treeAngleRange),`rotate(${a})translate(${this.outerRadius+o},0)`}).call(t).attr("class","xAxis").attr("font-family",null).call(t=>{t=t.append("g").attr("transform",t=>`translate(${n/2},${a.xAxis.Label.y.value})rotate(${a.xAxis.Label.rotate.value})`).append("text").attr("class",a.xAxis.Label.id).attr("text-anchor","middle").attr("dy","0.35em");this.renderAttr(t,a.xAxis.Label),this.renderText(t,a.xAxis.Label.text.value)});var c,d=a.xAxis["Text style"];i.selectAll(".tick text").remove(),d.switch.value&&(c=i.selectAll(".tick").append("g").attr("transform",t=>`translate(0,${("axisBottom"==r?-1:1)*a.xAxis["Text style"].offset.value})`).append("text").text(t=>s.hasOwnProperty("tickFormat")&&s.tickFormat.value?d3.format(`${s.tickFormat.value}`)(t):t).attr("class",d.id).attr("dy","0.35em"),s.hasOwnProperty("tickFormat")&&s.tickFormat.value.endsWith("E")&&i.selectAll(".tick text").call(t=>{this.valueFormat(t,s.tickFormat.value)}),this.renderAttr(c,d));let u=a.xAxis.Grid;u.switch.value&&e.append("g").selectAll("gridpath").data(i.selectAll(".tick").data()).join("path").attr("d",t=>{let a=d3.path();return a.arc(0,0,l(t)+(l.bandwidth?l.bandwidth()/2:0)+this.outerRadius+o,this.treeStartAngle*Math.PI/180,(this.treeEndAngle-90)*Math.PI/180),a.toString()}).attr("fill","none").attr("class",u.id).call(t=>this.renderAttr(t,u)),i.selectAll(".tick line").attr("class","tick-line").call(t=>{this.renderAttr(t,s)}),i.selectAll(".domain").call(t=>{this.renderAttr(t,s)}),a.xAxis.Tick.removePath.value&&i.selectAll(".domain").remove(),a.xAxis.Tick.removeTick.value&&i.selectAll(".tick .tick-line").remove()}}window.normalTree=new NormalTree,normalTree.setExampleData(["/static/Ali/data/NJ_tree.treefile"]);let queryParams=new URLSearchParams(window.location.search);if(queryParams.has("originalJsonDataUri")){let t=queryParams.get("originalJsonDataUri")+`?v=${Math.random()}`;d3.json(t).then(t=>{normalTree.importOriginalJsonData(t),d3.select("#page-loading-box").remove()}).catch(t=>{console.log(t),normalTree.showMessageBox("cuIcon-roundclose","No such json file!","error"),d3.select("#page-loading-box").remove()})}else d3.text("/static/Ali/data/NJ_tree.treefile").then(function(t){normalTree.onLoadNewFile(t),d3.select("#page-loading-box").remove()});