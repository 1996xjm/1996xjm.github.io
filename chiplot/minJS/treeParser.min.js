class TreeParser{constructor(){}identifyTreeFile(t){if(console.log(t),"object"==typeof t)return console.log({aa:t}),this.parsePhyloxml(t);{let e=t.trim().split("\n");return e[0].trim().toUpperCase().startsWith("#NEXUS")?this.parseNexus(e):this.parseNewick(t)}}parseNewick(e,A){this.nodeArr=[];const v=this;e=(e=(e=(e=e.replaceAll("\n","").replaceAll("\r","")).slice(e.indexOf("("))).trim()).endsWith(";")?e.slice(0,-1):e;let W=0;let t=function t(r,e=void 0){let l=0,i=!1,s="";for(let e=0,t=0,n=0;n<r.length;n++)if(!["'",'"'].includes(r[n])||i){if(r[n]==s&&i&&(i=!1),"("!=r[n]||i||e++,")"!=r[n]||i||t++,e==t){l=n;break}}else i=!0,s=r[n];let n=r.slice(l+1).split(":");for(let e=0;e<n.length;e++)n[e]=n[e].trim();if(1==n.length&&n.push(void 0),n[1]){let e=n[1].match(/\[[0-9.]*\]/);e&&(n[0]=e[0].slice(1,-1),console.log("处理bt值隐藏在[]里面的情况",e,n))}let h={name:n[0],length:n[1]?Number(n[1].match(/^[^[]*/g)[0]):Number(n[1]),btArr:[],children:[],nodeIndex:`N${W}`,uniformNodeId:`N${W}`,parent:e};if(v.nodeArr.push(h),W++,""!=n[0]){var a=n[0].match(/^\d+(\.\d+)?\/\d+(\.\d+)?$/);n[0].split("/").forEach(e=>{isNaN(Number(e))||h.btArr.push(Number(e))});let e=n[0].match(/\[&.*\]/);if(e){var o=e[0].slice(2,-1);let t=[],n=0,r=0,l={};var d=e=>{let t=e.join("").split("=");t.length<2||(t[1].startsWith("{")?l[t[0]]=t[1].slice(1,-1).split(",").map(e=>Number(e)):(e=t[1].startsWith('"')?Number(t[1].slice(1,-1)):Number(t[1]),l[t[0]]=isNaN(e)?t[1].slice(1,-1):e))};for(let e=0;e<o.length;e++)","==o[e]?n==r?(d(t),t=[]):t.push(o[e]):("{"==o[e]?n++:"}"==o[e]&&r++,t.push(o[e])),e==o.length-1&&d(t);h.otherProperty_L=l}else null==a&&isNaN(Number(n[0]))&&(h.hasInternalNodeID=!0,h.internalNodeID=n[0],h.uniformNodeId=n[0])}var c=r.slice(0,l+1);let m=[],p=0,u=0,f=!1,N="",g=0,b=0;for(let e=0;e<c.length;e++)if("("==c[e])m.push(c[e]),f||p++;else if("["==c[e])m.push(c[e]),g++;else if("]"==c[e])m.push(c[e]),b++;else if(","==c[e])if(p-u==1&&g==b){let n=m.slice(1).join("").trim();if(m=m.slice(0,1),n.startsWith("("))h.children.push(t(n,h));else{let t=[];if(n.startsWith("'")||n.startsWith('"')){console.log(n);var I=n[0],I=n.lastIndexOf(I);t[0]=n.slice(1,I),t[1]=I==n.length-1?void 0:n.slice(n.lastIndexOf(":")+1)}else{t=n.split(":");for(let e=0;e<t.length;e++)t[e]=t[e].trim()}1==t.length&&t.push(void 0);let e={name:t[0].match(/^[^[]*/g)[0],length:t[1]?Number(t[1].match(/^[^[]*/g)[0]):Number(t[1]),nodeIndex:`N${W}`,parent:h};A&&e.name in A&&(e.name=A[e.name]),e.uniformNodeId=e.name,h.children.push(e),v.nodeArr.push(e),W++}}else m.push(c[e]);else")"==c[e]?(m.push(c[e]),f||u++):["'",'"'].includes(c[e])&&!f?(f=!0,m.push(c[e]),N=c[e]):(c[e]==N&&f&&(f=!1),m.push(c[e]));let x=m.slice(1,m.lastIndexOf(")")).join("").trim();if(x.startsWith("("))h.children.push(t(x,h));else{let t=[];if(x.startsWith("'")||x.startsWith('"'))a=x[0],a=x.lastIndexOf(a),t[0]=x.slice(1,a),t[1]=a==x.length-1?void 0:x.slice(x.lastIndexOf(":")+1);else{t=x.split(":");for(let e=0;e<t.length;e++)t[e]=t[e].trim()}1==t.length&&t.push(void 0);let e={name:t[0].match(/^[^[]*/g)[0],length:t[1]?Number(t[1].match(/^[^[]*/g)[0]):Number(t[1]),nodeIndex:`N${W}`,parent:h};A&&e.name in A&&(e.name=A[e.name]),e.uniformNodeId=e.name,h.children.push(e),v.nodeArr.push(e),W++}return h}(e);if(isNaN(t.length)&&(t.length=0),"otherProperty_L"in t)for(var n in t.otherProperty_L)n.includes("95%")&&("95%"!=n&&"height_95%_HPD"!=n&&"95%HPD"!=n||(n=t.otherProperty_L[n],t.length=Number(((n[1]-n[0])/3*2).toFixed(10))),t.isDivergenceTimeTree=!0);return this.root=t,t}parseNexus(t){let r=!1,l=!1,i=!1,s={},h=[];for(let e=0;e<t.length;e++){let n=t[e].trim();if(n.toUpperCase().startsWith("BEGIN TREE"))console.log(n),r=!0;else{if(r&&n.toUpperCase().startsWith("END;")){console.log("树文件结束");break}if(r)if(n.toUpperCase().startsWith("TRANSLATE"))l=!0;else{let e=n.match(/^(\d+)[ \t](.*)[;,]?/);if(e&&l&&(s[e[1]]=e[2].endsWith(",")||e[2].endsWith(";")?e[2].slice(0,-1):e[2]),n.toUpperCase().startsWith("TREE")||n.toUpperCase().startsWith("UTREE")){let e=n.match(/tree (.+) =/i),t="";t=e?e[1].trim():`tree${h.length+1}`,h.push({name:t,newick:-1!=n.indexOf("(")?n.slice(n.indexOf("(")):""}),l=!1,i=!0}else i&&(h[h.length-1].newick+=n,n.endsWith(";")&&(i=!1))}}}return console.log(h),console.log(s),this.parseNewick(h[0].newick,s)}parsePhyloxml(e){const s=this;this.nodeArr=[];let h={},a=0;let t=function r(e,t=void 0){let n=e.selectChildren(),l={name:"",length:null!=e.attr("branch_length")?Number(e.attr("branch_length")):NaN,btArr:[],children:[],nodeIndex:`N${a}`,parent:t};a++,s.nodeArr.push(l);let i=[];return n.each(function(){let e=d3.select(this),t=e.node();var n=t.tagName;switch(i.push(n),n){case"name":l.name=t.innerHTML.trim(),l.name in h?(h[l.name]++,l.name=`${l.name}${h[l.name]}`):h[l.name]=0;break;case"clade":l.children.push(r(e,l));break;case"branch_length":l.length=Number(t.innerHTML.trim());break;case"taxonomy":l.name=e.select("scientific_name").text().trim(),l.name in h?(h[l.name]++,l.name=`${l.name}${h[l.name]}`):h[l.name]=0;break;case"confidence":l.btArr.push(Number(t.innerHTML))}}),i.includes("clade")||delete l.children,l}(d3.select(e).select("phylogeny").selectChildren("clade"));return isNaN(t.length)&&(t.length=0),this.root=t,t}reRoot(t,e=.5){var n=this.nodeArr.findIndex(e=>e.nodeIndex==t);console.log("nodeIndex",n);var r,l=this.nodeArr[n];if(console.log(t,l),"N0"==t)return l;let i={children:[],btArr:[],nodeIndex:"N0",uniformNodeId:"N0"};let s={};for(r in l)s[r]=l[r];s.length=l.length*(1-e),s.parent=i,i.children.push(s);let h=function e(t){let n={children:[]};return t.parent.children.forEach(e=>{e!=t&&n.children.push(e)}),n.length=t.length,n.btArr=t.parent.btArr,n.nodeIndex=t.nodeIndex,n.uniformNodeId=t.uniformNodeId,n.name=t.parent.name,t.parent&&t.parent.parent&&n.children.push(e(t.parent)),n}(l);return h.length=l.length*e,h.nodeIndex="N-1",h.uniformNodeId="N-1",i.children.push(h),i.children.reverse(),i.length=l.length*e,i}}export{TreeParser};